{"ast":null,"code":"(function (global, factory) {\n  /* istanbul ignore next */\n  if (typeof exports === 'object' && typeof module !== 'undefined') {\n    module.exports = factory;\n  } else if (typeof define === 'function' && define.amd) {\n    define('JZZ.midi.SMF', ['JZZ'], factory);\n  } else {\n    factory(JZZ);\n  }\n})(this, function (JZZ) {\n  /* istanbul ignore next */\n  if (JZZ.MIDI.SMF) return;\n  var _ver = '1.6.7';\n  var _now = JZZ.lib.now;\n\n  function _error(s) {\n    throw new Error(s);\n  }\n\n  function _num(n) {\n    var s = '';\n    if (n > 0x1fffff) s += String.fromCharCode((n >> 21 & 0x7f) + 0x80);\n    if (n > 0x3fff) s += String.fromCharCode((n >> 14 & 0x7f) + 0x80);\n    if (n > 0x7f) s += String.fromCharCode((n >> 7 & 0x7f) + 0x80);\n    s += String.fromCharCode(n & 0x7f);\n    return s;\n  }\n\n  function _num2(n) {\n    return String.fromCharCode(n >> 8) + String.fromCharCode(n & 0xff);\n  }\n\n  function _num4(n) {\n    return String.fromCharCode(n >> 24 & 0xff) + String.fromCharCode(n >> 16 & 0xff) + String.fromCharCode(n >> 8 & 0xff) + String.fromCharCode(n & 0xff);\n  }\n\n  function _num4le(n) {\n    return String.fromCharCode(n & 0xff) + String.fromCharCode(n >> 8 & 0xff) + String.fromCharCode(n >> 16 & 0xff) + String.fromCharCode(n >> 24 & 0xff);\n  }\n\n  function SMF() {\n    var self = this;\n\n    if (!(self instanceof SMF)) {\n      self = new SMF();\n      delete self.ppqn;\n    }\n\n    var type = 1;\n    var ppqn = 96;\n    var fps;\n    var ppf;\n\n    if (arguments.length == 1) {\n      if (arguments[0] instanceof SMF) {\n        return arguments[0].copy();\n      }\n\n      if (arguments[0] instanceof SYX) {\n        self.type = 0;\n        self.ppqn = ppqn;\n        self.push(new MTrk());\n\n        for (var i = 0; i < arguments[0].length; i++) self[0].add(0, arguments[0][i]);\n\n        return self;\n      }\n\n      try {\n        if (arguments[0] instanceof ArrayBuffer) {\n          self.load(String.fromCharCode.apply(null, new Uint8Array(arguments[0])));\n          return self;\n        }\n      } catch (err) {\n        /**/\n      }\n\n      try {\n        if (arguments[0] instanceof Uint8Array || arguments[0] instanceof Int8Array) {\n          self.load(String.fromCharCode.apply(null, new Uint8Array(arguments[0])));\n          return self;\n        }\n      } catch (err) {\n        /**/\n      }\n\n      try {\n        /* istanbul ignore next */\n        if (arguments[0] instanceof Buffer) {\n          self.load(arguments[0].toString('binary'));\n          return self;\n        }\n      } catch (err) {\n        /**/\n      }\n\n      if (typeof arguments[0] == 'string' && arguments[0] != '0' && arguments[0] != '1' && arguments[0] != '2') {\n        self.load(arguments[0]);\n        return self;\n      }\n\n      type = parseInt(arguments[0]);\n    } else if (arguments.length == 2) {\n      type = parseInt(arguments[0]);\n      ppqn = parseInt(arguments[1]);\n    } else if (arguments.length == 3) {\n      type = parseInt(arguments[0]);\n      fps = parseInt(arguments[1]);\n      ppf = parseInt(arguments[2]);\n    } else if (arguments.length) _error('Invalid parameters');\n\n    if (isNaN(type) || type < 0 || type > 2) _error('Invalid parameters');\n    self.type = type;\n\n    if (typeof fps == 'undefined') {\n      if (isNaN(ppqn) || ppqn < 0 || ppqn > 0xffff) _error('Invalid parameters');\n      self.ppqn = ppqn;\n    } else {\n      if (fps != 24 && fps != 25 && fps != 29 && fps != 30) _error('Invalid parameters');\n      if (isNaN(ppf) || ppf < 0 || ppf > 0xff) _error('Invalid parameters');\n      self.fps = fps;\n      self.ppf = ppf;\n    }\n\n    return self;\n  }\n\n  SMF.version = function () {\n    return _ver;\n  };\n\n  SMF.prototype = [];\n  SMF.prototype.constructor = SMF;\n\n  SMF.prototype.copy = function () {\n    var smf = new SMF();\n    smf.type = this.type;\n    smf.ppqn = this.ppqn;\n    smf.fps = this.fps;\n    smf.ppf = this.ppf;\n    smf.rmi = this.rmi;\n    smf.ntrk = this.ntrk;\n\n    for (var i = 0; i < this.length; i++) smf.push(this[i].copy());\n\n    return smf;\n  };\n\n  function _issue(off, msg, data, tick, track) {\n    var w = {\n      off: off,\n      msg: msg,\n      data: data\n    };\n    if (typeof tick != 'undefined') w.tick = tick;\n    if (typeof track != 'undefined') w.track = track;\n    return w;\n  }\n\n  SMF.prototype._complain = function (off, msg, data) {\n    if (!this._warn) this._warn = [];\n\n    this._warn.push(_issue(off, msg, data));\n  };\n\n  SMF.prototype.load = function (s) {\n    var off = 0;\n\n    if (s.substr(0, 4) == 'RIFF' && s.substr(8, 8) == 'RMIDdata') {\n      this.rmi = true;\n      off = 20;\n      s = s.substr(20, s.charCodeAt(16) + s.charCodeAt(17) * 0x100 + s.charCodeAt(18) * 0x10000 + s.charCodeAt(19) * 0x1000000);\n    }\n\n    this.loadSMF(s, off);\n  };\n\n  var MThd0006 = 'MThd' + String.fromCharCode(0) + String.fromCharCode(0) + String.fromCharCode(0) + String.fromCharCode(6);\n\n  SMF.prototype.loadSMF = function (s, off) {\n    if (!s.length) _error('Empty file');\n\n    if (s.substr(0, 8) != MThd0006) {\n      var z = s.indexOf(MThd0006);\n\n      if (z != -1) {\n        s = s.substr(z);\n\n        this._complain(off, 'Extra leading characters', z);\n\n        off += z;\n      } else _error('Not a MIDI file');\n    }\n\n    this._off = off;\n    this.type = s.charCodeAt(8) * 16 + s.charCodeAt(9);\n    this._off_type = off + 8;\n    this.ntrk = s.charCodeAt(10) * 16 + s.charCodeAt(11);\n    this._off_ntrk = off + 10;\n\n    if (s.charCodeAt(12) > 0x7f) {\n      this.fps = 0x100 - s.charCodeAt(12);\n      this.ppf = s.charCodeAt(13);\n      this._off_fps = off + 12;\n      this._off_ppf = off + 13;\n    } else {\n      this.ppqn = s.charCodeAt(12) * 256 + s.charCodeAt(13);\n      this._off_ppqn = off + 12;\n    }\n\n    if (this.type > 2) this._complain(8 + off, 'Invalid MIDI file type', this.type);else if (this.type == 0 && this.ntrk > 1) this._complain(10 + off, 'Wrong number of tracks for the type 0 MIDI file', this.ntrk);\n    if (!this.ppf && !this.ppqn) _error('Invalid MIDI header');\n    var n = 0;\n    var p = 14;\n\n    while (p < s.length - 8) {\n      var offset = p + off;\n      var type = s.substr(p, 4);\n      if (type == 'MTrk') n++;\n      var len = (s.charCodeAt(p + 4) << 24) + (s.charCodeAt(p + 5) << 16) + (s.charCodeAt(p + 6) << 8) + s.charCodeAt(p + 7);\n\n      if (len <= 0) {\n        // broken file\n        len = s.length - p - 8;\n\n        this._complain(p + off + 4, 'Invalid track length', s.charCodeAt(p + 4) + '/' + s.charCodeAt(p + 5) + '/' + s.charCodeAt(p + 6) + '/' + s.charCodeAt(p + 7));\n      }\n\n      p += 8;\n      var data = s.substr(p, len);\n      this.push(new Chunk(type, data, offset));\n      if (type == 'MThd') this._complain(offset, 'Unexpected chunk type', 'MThd');\n      p += len;\n    }\n\n    if (n != this.ntrk) {\n      this._complain(off + 10, 'Incorrect number of tracks', this.ntrk);\n\n      this.ntrk = n;\n    }\n\n    if (!this.ntrk) _error('No MIDI tracks');\n    if (!this.type && this.ntrk > 1 || this.type > 2) this.type = 1;\n    if (p < s.length) this._complain(off + p, 'Extra trailing characters', s.length - p);\n    if (p > s.length) this._complain(off + s.length, 'Incomplete data', p - s.length);\n  };\n\n  function Warn(obj) {\n    if (!(this instanceof Warn)) return new Warn(obj);\n\n    for (var k in obj) if (obj.hasOwnProperty(k)) this[k] = obj[k];\n  }\n\n  Warn.prototype.toString = function () {\n    var a = [];\n    if (typeof this.off != 'undefined') a.push('offset ' + this.off);\n    if (typeof this.track != 'undefined') a.push('track ' + this.track);\n    if (typeof this.tick != 'undefined') a.push('tick ' + this.tick);\n    return a.join(' ') + ' -- ' + this.msg + ' (' + this.data + ')';\n  };\n\n  SMF.prototype.tracks = function () {\n    var t = 0;\n\n    for (var i = 0; i < this.length; i++) if (this[i] instanceof MTrk) t++;\n\n    return t;\n  };\n\n  function _reset_state(w, s) {\n    var i;\n\n    for (i = 0; i < 16; i++) {\n      if (s[i]) {\n        if (s[i].rm && s[i].rl && s[i].rm[0][2] == 0x7f && s[i].rl[0][2] == 0x7f) {\n          s[i].rm[1] = true;\n          s[i].rl[1] = true;\n        }\n\n        _check_unused(w, s, i, 'bm');\n\n        _check_unused(w, s, i, 'bl');\n\n        _check_unused(w, s, i, 'nm');\n\n        _check_unused(w, s, i, 'nl');\n\n        _check_unused(w, s, i, 'rm');\n\n        _check_unused(w, s, i, 'rl');\n      }\n\n      s[i] = {};\n    }\n  }\n\n  function _update_state(w, s, msg) {\n    if (!msg.length || msg[0] < 0x80) return;\n\n    if (msg.isGmReset() || msg.isGsReset() || msg.isXgReset()) {\n      _reset_state(w, s);\n\n      return;\n    }\n\n    var st = msg[0] >> 4;\n    var ch = msg[0] & 15;\n    var m;\n\n    if (st == 0xb) {\n      switch (msg[1]) {\n        case 0:\n          _check_unused(w, s, ch, 'bm');\n\n          s[ch].bm = [msg, false];\n          break;\n\n        case 0x20:\n          _check_unused(w, s, ch, 'bl');\n\n          s[ch].bl = [msg, false];\n          break;\n\n        case 0x62:\n          _check_unused(w, s, ch, 'nl');\n\n          _check_unused(w, s, ch, 'rm');\n\n          _check_unused(w, s, ch, 'rl');\n\n          s[ch].nl = [msg, false];\n          break;\n\n        case 0x63:\n          _check_unused(w, s, ch, 'nm');\n\n          _check_unused(w, s, ch, 'rm');\n\n          _check_unused(w, s, ch, 'rl');\n\n          s[ch].nm = [msg, false];\n          break;\n\n        case 0x64:\n          _check_unused(w, s, ch, 'rl');\n\n          _check_unused(w, s, ch, 'nm');\n\n          _check_unused(w, s, ch, 'nl');\n\n          s[ch].rl = [msg, false];\n          break;\n\n        case 0x65:\n          _check_unused(w, s, ch, 'rm');\n\n          _check_unused(w, s, ch, 'nm');\n\n          _check_unused(w, s, ch, 'nl');\n\n          s[ch].rm = [msg, false];\n          break;\n\n        case 0x6:\n        case 0x26:\n        case 0x60:\n        case 0x61:\n          if (s[ch].rm && s[ch].rl) {\n            s[ch].rm[1] = true;\n            s[ch].rl[1] = true;\n          }\n\n          if (s[ch].rm && !s[ch].rl && !s[ch].rm[1]) {\n            m = s[ch].rm[0];\n            w.push(_issue(m._off, 'No matching RPN LSB', m.toString(), m.tt, m.track));\n            s[ch].rm[1] = true;\n          }\n\n          if (!s[ch].rm && s[ch].rl && !s[ch].rl[1]) {\n            m = s[ch].rl[0];\n            w.push(_issue(m._off, 'No matching RPN MSB', m.toString(), m.tt, m.track));\n            s[ch].rl[1] = true;\n          }\n\n          if (s[ch].nm && s[ch].nl) {\n            s[ch].nm[1] = true;\n            s[ch].nl[1] = true;\n          }\n\n          if (s[ch].nm && !s[ch].nl && !s[ch].nm[1]) {\n            m = s[ch].nm[0];\n            w.push(_issue(m._off, 'No matching NRPN LSB', m.toString(), m.tt, m.track));\n            s[ch].nm[1] = true;\n          }\n\n          if (!s[ch].nm && s[ch].nl && !s[ch].nl[1]) {\n            m = s[ch].nl[0];\n            w.push(_issue(m._off, 'No matching NRPN MSB', m.toString(), m.tt, m.track));\n            s[ch].nl[1] = true;\n          }\n\n          if (!s[ch].rm && !s[ch].rl && !s[ch].nm && !s[ch].nl) {\n            w.push(_issue(msg._off, 'RPN/NRPN not set', msg.toString(), msg.tt, msg.track));\n          }\n\n          if (s[ch].rm && s[ch].rl && s[ch].rm[0][2] == 0x7f && s[ch].rl[0][2] == 0x7f) {\n            w.push(_issue(msg._off, 'RPN/NRPN not set', msg.toString(), msg.tt, msg.track));\n          }\n\n          break;\n      }\n\n      return;\n    }\n\n    if (st == 0xc) {\n      if (s[ch].bm) s[ch].bm[1] = true;\n      if (s[ch].bl) s[ch].bl[1] = true;\n\n      if (s[ch].bl && !s[ch].bm) {\n        m = s[ch].bl[0];\n        w.push(_issue(m._off, 'No matching Bank Select MSB', m.toString(), m.tt, m.track));\n      }\n\n      if (s[ch].bm && !s[ch].bl) {\n        m = s[ch].bm[0];\n        w.push(_issue(m._off, 'No matching Bank Select LSB', m.toString(), m.tt, m.track));\n      }\n    }\n  }\n\n  function _check_unused(w, s, c, x) {\n    if (s[c][x] && !s[c][x][1]) {\n      var str;\n\n      switch (x) {\n        case 'bm':\n        case 'bl':\n          str = 'Unnecessary Bank Select';\n          break;\n\n        case 'nm':\n        case 'nl':\n          str = 'Unnecessary NRPN';\n          break;\n\n        case 'rm':\n        case 'rl':\n          str = 'Unnecessary RPN';\n          break;\n      }\n\n      var m = s[c][x][0];\n      w.push(_issue(m._off, str, m.toString(), m.tt, m.track));\n      delete s[c][x];\n    }\n  }\n\n  SMF.prototype.validate = function () {\n    var i, k, z;\n    var w = [];\n    if (this._warn) for (i = 0; i < this._warn.length; i++) w.push(Warn(this._warn[i]));\n\n    var mm = _sort(this);\n\n    k = 0;\n\n    for (i = 0; i < this.length; i++) if (this[i] instanceof MTrk) {\n      this[i]._validate(w, k);\n\n      k++;\n    }\n\n    var st = {};\n\n    _reset_state(w, st);\n\n    for (i = 0; i < mm.length; i++) {\n      z = _validate_midi(mm[i], this.type == 1);\n\n      if (z) {\n        z.track = mm[i].track;\n        w.push(z);\n      }\n\n      _update_state(w, st, mm[i]);\n    }\n\n    _reset_state(w, st);\n\n    w.sort(function (a, b) {\n      return (a.off || 0) - (b.off || 0) || (a.track || 0) - (b.track || 0) || (a.tick || 0) - (b.tick || 0);\n    });\n\n    if (w.length) {\n      for (i = 0; i < w.length; i++) w[i] = Warn(w[i]);\n\n      return w;\n    }\n  };\n\n  SMF.prototype.dump = function (rmi) {\n    var s = '';\n\n    if (rmi) {\n      s = this.dump();\n      return 'RIFF' + _num4le(s.length + 12) + 'RMIDdata' + _num4le(s.length) + s;\n    }\n\n    this.ntrk = 0;\n\n    for (var i = 0; i < this.length; i++) {\n      if (this[i] instanceof MTrk) this.ntrk++;\n      s += this[i].dump();\n    }\n\n    s = (this.ppqn ? _num2(this.ppqn) : String.fromCharCode(0x100 - this.fps) + String.fromCharCode(this.ppf)) + s;\n    s = MThd0006 + String.fromCharCode(0) + String.fromCharCode(this.type) + _num2(this.ntrk) + s;\n    return s;\n  };\n\n  SMF.prototype.toBuffer = function (rmi) {\n    return Buffer.from(this.dump(rmi), 'binary');\n  };\n\n  SMF.prototype.toUint8Array = function (rmi) {\n    var str = this.dump(rmi);\n    var buf = new ArrayBuffer(str.length);\n    var arr = new Uint8Array(buf);\n\n    for (var i = 0; i < str.length; i++) arr[i] = str.charCodeAt(i);\n\n    return arr;\n  };\n\n  SMF.prototype.toArrayBuffer = function (rmi) {\n    return this.toUint8Array(rmi).buffer;\n  };\n\n  SMF.prototype.toInt8Array = function (rmi) {\n    return new Int8Array(this.toArrayBuffer(rmi));\n  };\n\n  SMF.prototype.toString = function () {\n    var i;\n    this.ntrk = 0;\n\n    for (i = 0; i < this.length; i++) if (this[i] instanceof MTrk) this.ntrk++;\n\n    var a = ['SMF:', '  type: ' + this.type];\n    if (this.ppqn) a.push('  ppqn: ' + this.ppqn);else a.push('  fps: ' + this.fps, '  ppf: ' + this.ppf);\n    a.push('  tracks: ' + this.ntrk);\n\n    for (i = 0; i < this.length; i++) {\n      a.push(this[i].toString());\n    }\n\n    return a.join('\\n');\n  };\n\n  function _var2num(s) {\n    if (!s.length) return 0; // missing last byte\n\n    if (s.charCodeAt(0) < 0x80) return [1, s.charCodeAt(0)];\n    var x = s.charCodeAt(0) & 0x7f;\n    x <<= 7;\n    if (s.charCodeAt(1) < 0x80) return [2, x + s.charCodeAt(1)];\n    x += s.charCodeAt(1) & 0x7f;\n    x <<= 7;\n    if (s.charCodeAt(2) < 0x80) return [3, x + s.charCodeAt(2)];\n    x += s.charCodeAt(2) & 0x7f;\n    x <<= 7;\n    x += s.charCodeAt(3) & 0x7f;\n    return [4, s.charCodeAt(3) < 0x80 ? x : -x];\n  }\n\n  function _msglen(n) {\n    switch (n & 0xf0) {\n      case 0x80:\n      case 0x90:\n      case 0xa0:\n      case 0xb0:\n      case 0xe0:\n        return 2;\n\n      case 0xc0:\n      case 0xD0:\n        return 1;\n    }\n\n    switch (n) {\n      case 0xf1:\n      case 0xf3:\n        return 1;\n\n      case 0xf2:\n        return 2;\n    }\n\n    return 0;\n  }\n\n  function _sort(smf) {\n    var i, j;\n    var tt = [];\n    var mm = [];\n\n    for (i = 0; i < smf.length; i++) if (smf[i] instanceof MTrk) tt.push(smf[i]);\n\n    if (smf.type != 1) {\n      for (i = 0; i < tt.length; i++) {\n        for (j = 0; j < tt[i].length; j++) {\n          tt[i][j].track = i;\n          mm.push(tt[i][j]);\n        }\n      }\n    } else {\n      var t = 0;\n      var pp = [];\n\n      for (i = 0; i < tt.length; i++) pp[i] = 0;\n\n      while (true) {\n        var b = true;\n        var m = 0;\n\n        for (i = 0; i < tt.length; i++) {\n          while (pp[i] < tt[i].length && tt[i][pp[i]].tt == t) {\n            tt[i][pp[i]].track = i;\n            mm.push(tt[i][pp[i]]);\n            pp[i]++;\n          }\n\n          if (pp[i] >= tt[i].length) continue;\n          if (b) m = tt[i][pp[i]].tt;\n          b = false;\n          if (m > tt[i][pp[i]].tt) m = tt[i][pp[i]].tt;\n        }\n\n        t = m;\n        if (b) break;\n      }\n    }\n\n    return mm;\n  }\n\n  SMF.prototype.annotate = function () {\n    var mm = _sort(this);\n\n    var ctxt = JZZ.Context();\n\n    for (var i = 0; i < mm.length; i++) {\n      if (mm[i].lbl) mm[i].lbl = undefined;\n\n      ctxt._read(mm[i]);\n    }\n\n    return this;\n  };\n\n  SMF.prototype.player = function () {\n    var pl = new Player();\n    pl.ppqn = this.ppqn;\n    pl.fps = this.fps;\n    pl.ppf = this.ppf;\n    var i;\n    var e;\n\n    var mm = _sort(this);\n\n    if (this.type == 2) {\n      var tr = 0;\n      var m = 0;\n      var t = 0;\n\n      for (i = 0; i < mm.length; i++) {\n        e = JZZ.MIDI(mm[i]);\n\n        if (tr != e.track) {\n          tr = e.track;\n          m = t;\n        }\n\n        t = e.tt + m;\n        e.tt = t;\n\n        pl._data.push(e);\n      }\n    } else {\n      for (i = 0; i < mm.length; i++) {\n        e = JZZ.MIDI(mm[i]);\n\n        pl._data.push(e);\n      }\n    }\n\n    pl._type = this.type;\n    pl._tracks = this.tracks();\n\n    pl._timing();\n\n    return pl;\n  };\n\n  function Chunk(t, d, off) {\n    if (!(this instanceof Chunk)) return new Chunk(t, d, off);\n    var i;\n    if (this.sub[t]) return this.sub[t](t, d, off);\n    if (typeof t != 'string' || t.length != 4) _error(\"Invalid chunk type: \" + t);\n\n    for (i = 0; i < t.length; i++) if (t.charCodeAt(i) < 0 || t.charCodeAt(i) > 255) _error(\"Invalid chunk type: \" + t);\n\n    if (typeof d != 'string') _error(\"Invalid data type: \" + d);\n\n    for (i = 0; i < d.length; i++) if (d.charCodeAt(i) < 0 || d.charCodeAt(i) > 255) _error(\"Invalid data character: \" + d[i]);\n\n    this.type = t;\n    this.data = d;\n    this._off = off;\n  }\n\n  SMF.Chunk = Chunk;\n  Chunk.prototype = [];\n  Chunk.prototype.constructor = Chunk;\n\n  Chunk.prototype.copy = function () {\n    return new Chunk(this.type, this.data);\n  };\n\n  Chunk.prototype.sub = {\n    'MTrk': function (t, d, off) {\n      return new MTrk(d, off);\n    }\n  };\n\n  Chunk.prototype.dump = function () {\n    return this.type + _num4(this.data.length) + this.data;\n  };\n\n  Chunk.prototype.toString = function () {\n    return this.type + ': ' + this.data.length + ' bytes';\n  };\n\n  function _validate_msg_data(trk, s, p, m, t, off) {\n    var x = s.substr(p, m);\n\n    if (x.length < m) {\n      trk._complain(off, 'Incomplete track data', m - x.length, t);\n\n      x = (x + '\\x00\\x00').substr(0, m);\n    }\n\n    for (var i = 0; i < m; i++) if (x.charCodeAt(i) > 127) {\n      trk._complain(off + i, 'Bad MIDI value set to 0', x.charCodeAt(i), t);\n\n      x = x.substr(0, i) + '\\x00' + x.substr(i + 1);\n    }\n\n    return x;\n  }\n\n  function _validate_number(trk, s, off, t, tt) {\n    var nn = _var2num(s);\n\n    if (tt) t += nn[1];\n\n    if (nn[1] < 0) {\n      nn[1] = -nn[1];\n\n      trk._complain(off, \"Bad byte sequence\", s.charCodeAt(0) + '/' + s.charCodeAt(1) + '/' + s.charCodeAt(2) + '/' + s.charCodeAt(3), t);\n    } else if (nn[0] == 4 && nn[1] < 0x200000) {\n      trk._complain(off, \"Long VLQ value\", s.charCodeAt(0) + '/' + s.charCodeAt(1) + '/' + s.charCodeAt(2) + '/' + s.charCodeAt(3), t);\n    } else if (nn[0] == 3 && nn[1] < 0x4000) {\n      trk._complain(off, \"Long VLQ value\", s.charCodeAt(0) + '/' + s.charCodeAt(1) + '/' + s.charCodeAt(2), t);\n    } else if (nn[0] == 2 && nn[1] < 0x80) {\n      trk._complain(off, \"Long VLQ value\", s.charCodeAt(0) + '/' + s.charCodeAt(1), t);\n    }\n\n    return nn;\n  }\n\n  function MTrk(s, off) {\n    if (!(this instanceof MTrk)) return new MTrk(s, off);\n    this._off = off;\n    this._orig = this;\n    this._tick = 0;\n\n    if (typeof s == 'undefined') {\n      this.push(new Event(0, '\\xff\\x2f', ''));\n      return;\n    }\n\n    var t = 0;\n    var p = 0;\n    var w = '';\n    var st;\n    var m;\n    off += 8;\n    var offset = p + off;\n\n    while (p < s.length) {\n      m = _validate_number(this, s.substr(p, 4), offset, t, true);\n      p += m[0];\n      t += m[1];\n      offset = p + off;\n\n      if (s.charCodeAt(p) == 0xff) {\n        st = s.substr(p, 2);\n\n        if (st.length < 2) {\n          this._complain(offset, 'Incomplete track data', 3 - st.length, t);\n\n          st = '\\xff\\x2f';\n        }\n\n        p += 2;\n        m = _validate_number(this, s.substr(p, 4), offset + 2, t);\n        p += m[0];\n        this.push(new Event(t, st, s.substr(p, m[1]), offset));\n        p += m[1];\n      } else if (s.charCodeAt(p) == 0xf0 || s.charCodeAt(p) == 0xf7) {\n        st = s.substr(p, 1);\n        p += 1;\n        m = _validate_number(this, s.substr(p, 4), offset + 1, t);\n        p += m[0];\n        this.push(new Event(t, st, s.substr(p, m[1]), offset));\n        p += m[1];\n      } else if (s.charCodeAt(p) & 0x80) {\n        w = s.substr(p, 1);\n        p += 1;\n        m = _msglen(w.charCodeAt(0));\n        if (w.charCodeAt(0) > 0xf0) this._complain(offset, 'Unexpected MIDI message', w.charCodeAt(0).toString(16), t);\n        this.push(new Event(t, w, _validate_msg_data(this, s, p, m, t, offset + 1), offset));\n        p += m;\n      } else if (w.charCodeAt(0) & 0x80) {\n        // running status\n        m = _msglen(w.charCodeAt(0));\n        if (w.charCodeAt(0) > 0xf0) this._complain(offset, 'Unexpected MIDI message', w.charCodeAt(0).toString(16), t);\n        this.push(new Event(t, w, _validate_msg_data(this, s, p, m, t, offset), offset));\n        p += m;\n      }\n    }\n  }\n\n  SMF.MTrk = MTrk;\n  MTrk.prototype = [];\n  MTrk.prototype.constructor = MTrk;\n  MTrk.prototype.type = 'MTrk';\n\n  MTrk.prototype.copy = function () {\n    var trk = new MTrk();\n    trk.length = 0;\n\n    for (var i = 0; i < this.length; i++) trk.push(new JZZ.MIDI(this[i]));\n\n    return trk;\n  };\n\n  function _shortmsg(msg) {\n    var s = msg.toString();\n\n    if (s.length > 80) {\n      s = s.substr(0, 78);\n      s = s.substr(0, s.lastIndexOf(' ')) + ' ...';\n    }\n\n    return s;\n  }\n\n  function _metaevent_len(msg, name, len) {\n    if (msg.dd.length < len) return _issue(msg._off, 'Invalid ' + name + ' meta event: ' + (msg.dd.length ? 'data too short' : 'no data'), _shortmsg(msg), msg.tt);\n    if (msg.dd.length > len) return _issue(msg._off, 'Invalid ' + name + ' meta event: data too long', _shortmsg(msg), msg.tt);\n  }\n\n  function _timing_first_track(msg, name) {\n    return _issue(msg._off, name + ' meta events must be in the first track', _shortmsg(msg), msg.tt);\n  }\n\n  function _validate_midi(msg, t1) {\n    var issue;\n\n    if (typeof msg.ff != 'undefined') {\n      if (msg.ff > 0x7f) return _issue(msg._off, 'Invalid meta event', _shortmsg(msg), msg.tt);else if (msg.ff == 0) {\n        issue = _metaevent_len(msg, 'Sequence Number', 2);\n        if (issue) return issue;\n      } else if (msg.ff < 10) {\n        if (!msg.dd.length) return _issue(msg._off, 'Invalid Text meta event: no data', _shortmsg(msg), msg.tt);\n      } else if (msg.ff == 32) {\n        issue = _metaevent_len(msg, 'Channel Prefix', 1);\n        if (issue) return issue;\n        if (msg.dd.charCodeAt(0) > 15) return _issue(msg._off, 'Invalid Channel Prefix meta event: incorrect data', _shortmsg(msg), msg.tt);\n      } else if (msg.ff == 33) {\n        issue = _metaevent_len(msg, 'MIDI Port', 1);\n        if (issue) return issue;\n        if (msg.dd.charCodeAt(0) > 127) return _issue(msg._off, 'Invalid MIDI Port meta event: incorrect data', _shortmsg(msg), msg.tt);\n      } else if (msg.ff == 47) {\n        issue = _metaevent_len(msg, 'End of Track', 0);\n        if (issue) return issue;\n      } else if (msg.ff == 81) {\n        issue = _metaevent_len(msg, 'Tempo', 3);\n        if (issue) return issue;\n        if (t1 && msg.track) return _timing_first_track(msg, 'Tempo');\n      } else if (msg.ff == 84) {\n        issue = _metaevent_len(msg, 'SMPTE', 5);\n        if (issue) return issue;\n        if ((msg.dd.charCodeAt(0) & 0x1f) >= 24 || msg.dd.charCodeAt(1) >= 60 || msg.dd.charCodeAt(2) >= 60 || msg.dd.charCodeAt(3) >= 30 || msg.dd.charCodeAt(4) >= 200 || msg.dd.charCodeAt(4) % 25) return _issue(msg._off, 'Invalid SMPTE meta event: incorrect data', _shortmsg(msg), msg.tt);else if (msg.dd.charCodeAt(0) >> 5 > 3) return _issue(msg._off, 'Invalid SMPTE meta event: incorrect format', msg.dd.charCodeAt(0) >> 5, msg.tt);\n        if (t1 && msg.track) return _timing_first_track(msg, 'SMPTE');\n      } else if (msg.ff == 88) {\n        issue = _metaevent_len(msg, 'Time Signature', 4);\n        if (issue) return issue;\n        if (msg.dd.charCodeAt(1) > 8) return _issue(msg._off, 'Invalid Time Signature meta event: incorrect data', _shortmsg(msg), msg.tt);\n        if (t1 && msg.track) return _timing_first_track(msg, 'Time Signature');\n      } else if (msg.ff == 89) {\n        issue = _metaevent_len(msg, 'Key Signature', 2);\n        if (issue) return issue;\n        if (msg.dd.charCodeAt(1) > 1 || msg.dd.charCodeAt(0) > 255 || msg.dd.charCodeAt(0) > 7 && msg.dd.charCodeAt(0) < 249) return _issue(msg._off, 'Invalid Key Signature meta event: incorrect data', msg.toString(), msg.tt);\n      } else if (msg.ff == 127) {// Sequencer Specific meta event\n      } else {\n        return _issue(msg._off, 'Unknown meta event', _shortmsg(msg), msg.tt);\n      }\n    } else {//\n    }\n  }\n\n  MTrk.prototype._validate = function (w, k) {\n    var i, z;\n    if (this._warn) for (i = 0; i < this._warn.length; i++) {\n      z = Warn(this._warn[i]);\n      z.track = k;\n      w.push(z);\n    }\n  };\n\n  MTrk.prototype._complain = function (off, msg, data, tick) {\n    if (!this._warn) this._warn = [];\n\n    this._warn.push(_issue(off, msg, data, tick));\n  };\n\n  MTrk.prototype.dump = function () {\n    var s = '';\n    var t = 0;\n    var m = '';\n    var i, j;\n\n    for (i = 0; i < this.length; i++) {\n      s += _num(this[i].tt - t);\n      t = this[i].tt;\n\n      if (typeof this[i].dd != 'undefined') {\n        s += '\\xff';\n        s += String.fromCharCode(this[i].ff);\n        s += _num(this[i].dd.length);\n        s += this[i].dd;\n      } else if (this[i][0] == 0xf0 || this[i][0] == 0xf7) {\n        s += String.fromCharCode(this[i][0]);\n        s += _num(this[i].length - 1);\n\n        for (j = 1; j < this[i].length; j++) s += String.fromCharCode(this[i][j]);\n      } else {\n        if (this[i][0] != m) {\n          m = this[i][0];\n          s += String.fromCharCode(this[i][0]);\n        }\n\n        for (j = 1; j < this[i].length; j++) s += String.fromCharCode(this[i][j]);\n      }\n    }\n\n    return 'MTrk' + _num4(s.length) + s;\n  };\n\n  MTrk.prototype.toString = function () {\n    var a = ['MTrk:'];\n\n    for (var i = 0; i < this.length; i++) {\n      a.push(this[i].tt + ': ' + this[i].toString());\n    }\n\n    return a.join('\\n  ');\n  };\n\n  MTrk.prototype.add = function (t, msg) {\n    t = parseInt(t);\n    if (isNaN(t) || t < 0) _error('Invalid parameter');\n    msg = JZZ.MIDI(msg);\n    msg.tt = t;\n    if (this[this._orig.length - 1].tt < t) this[this._orig.length - 1].tt = t; // end of track\n\n    if (msg.ff == 0x2f || msg[0] > 0xf0 && msg[0] != 0xf7) return this;\n    var i;\n\n    for (i = 0; i < this._orig.length - 1; i++) {\n      if (this._orig[i].tt > t) break;\n    }\n\n    this._orig.splice(i, 0, msg);\n\n    return this;\n  };\n\n  MTrk.prototype._ch = undefined;\n  MTrk.prototype._sxid = 0x7f;\n\n  MTrk.prototype._image = function () {\n    var F = function () {};\n\n    F.prototype = this._orig;\n    var img = new F();\n    img._ch = this._ch;\n    img._sxid = this._sxid;\n    img._tick = this._tick;\n    return img;\n  };\n\n  MTrk.prototype.send = function (msg) {\n    this._orig.add(this._tick, msg);\n\n    return this;\n  };\n\n  MTrk.prototype.tick = function (t) {\n    if (t != parseInt(t) || t < 0) throw RangeError('Bad tick value: ' + t);\n    if (!t) return this;\n\n    var img = this._image();\n\n    img._tick = this._tick + t;\n    return img;\n  };\n\n  MTrk.prototype.sxId = function (id) {\n    if (typeof id == 'undefined') id = MTrk.prototype._sxid;\n    if (id == this._sxid) return this;\n    if (id != parseInt(id) || id < 0 || id > 0x7f) throw RangeError('Bad MIDI value: ' + id);\n\n    var img = this._image();\n\n    img._sxid = id;\n    return img;\n  };\n\n  MTrk.prototype.ch = function (c) {\n    if (c == this._ch || typeof c == 'undefined' && typeof this._ch == 'undefined') return this;\n\n    if (typeof c != 'undefined') {\n      if (c != parseInt(c) || c < 0 || c > 15) throw RangeError('Bad channel value: ' + c + ' (must be from 0 to 15)');\n    }\n\n    var img = this._image();\n\n    img._ch = c;\n    return img;\n  };\n\n  MTrk.prototype.note = function (c, n, v, t) {\n    this.noteOn(c, n, v);\n\n    if (typeof this._ch == 'undefined') {\n      if (t > 0) this.tick(t).noteOff(c, n);\n    } else {\n      if (v > 0) this.tick(v).noteOff(c);\n    }\n\n    return this;\n  };\n\n  JZZ.lib.copyMidiHelpers(MTrk);\n\n  function Event(t, s, d, off) {\n    var midi;\n\n    if (s.charCodeAt(0) == 0xff) {\n      midi = JZZ.MIDI.smf(s.charCodeAt(1), d);\n    } else {\n      var a = [s.charCodeAt(0)];\n\n      for (var i = 0; i < d.length; i++) a.push(d.charCodeAt(i));\n\n      midi = JZZ.MIDI(a);\n    }\n\n    if (typeof off != 'undefined') midi._off = off;\n    midi.tt = t;\n    return midi;\n  }\n\n  function Player() {\n    var self = new JZZ.Widget();\n    self._info.name = 'MIDI Player';\n    self._info.manufacturer = 'Jazz-Soft';\n    self._info.version = _ver;\n    self.playing = false;\n    self._loop = 0;\n    self._data = [];\n    self._pos = 0;\n\n    self._tick = function (x) {\n      return function () {\n        x.tick();\n      };\n    }(self);\n\n    for (var k in Player.prototype) if (Player.prototype.hasOwnProperty(k)) self[k] = Player.prototype[k];\n\n    return self;\n  }\n\n  Player.prototype.onEnd = function () {};\n\n  Player.prototype.loop = function (n) {\n    if (n == parseInt(n) && n > 0) this._loop = n;else this._loop = n ? -1 : 0;\n  };\n\n  Player.prototype.play = function () {\n    this.event = undefined;\n    this.playing = true;\n    this.paused = false;\n    this._ptr = 0;\n    this._pos = 0;\n    this._p0 = 0;\n    this._t0 = _now();\n    this.tick();\n  };\n\n  Player.prototype.stop = function () {\n    this._pos = 0;\n    this.playing = false;\n    this.event = 'stop';\n    this.paused = undefined;\n  };\n\n  Player.prototype.pause = function () {\n    this.event = 'pause';\n  };\n\n  Player.prototype.resume = function () {\n    if (this.playing) return;\n\n    if (this.paused) {\n      this.event = undefined;\n      this._t0 = _now();\n      this.playing = true;\n      this.paused = false;\n      this.tick();\n    } else this.play();\n  };\n\n  Player.prototype.sndOff = function () {\n    var c;\n\n    for (c = 0; c < 16; c++) this._emit(JZZ.MIDI.allSoundOff(c));\n\n    for (c = 0; c < 16; c++) this._emit(JZZ.MIDI.resetAllControllers(c));\n  };\n\n  function _filter(e) {\n    this._receive(e);\n  }\n\n  Player.prototype._filter = _filter;\n\n  Player.prototype.filter = function (f) {\n    this._filter = f instanceof Function ? f : _filter;\n  };\n\n  function _div(s) {\n    return (s.charCodeAt(0) << 16) + (s.charCodeAt(1) << 8) + s.charCodeAt(2);\n  }\n\n  Player.prototype._receive = function (e) {\n    if (e.ff == 0x51 && this.ppqn) {\n      this._mul = this.ppqn * 1000.0 / _div(e.dd);\n      this.mul = this._mul * this._speed;\n      this._t0 = _now();\n      this._p0 = this._pos;\n    }\n\n    this._emit(e);\n  };\n\n  Player.prototype.tick = function () {\n    var t = _now();\n\n    var e;\n    this._pos = this._p0 + (t - this._t0) * this.mul;\n\n    for (; this._ptr < this._data.length; this._ptr++) {\n      e = this._data[this._ptr];\n      if (e.tt > this._pos) break;\n\n      this._filter(e);\n    }\n\n    if (this._ptr >= this._data.length) {\n      if (this._loop && this._loop != -1) this._loop--;\n\n      if (this._loop) {\n        this._ptr = 0;\n        this._p0 = 0;\n        this._t0 = t;\n      } else this.stop();\n\n      this.onEnd();\n    }\n\n    if (this.event == 'stop') {\n      this.playing = false;\n      this.paused = false;\n      this._pos = 0;\n      this._ptr = 0;\n      this.sndOff();\n      this.event = undefined;\n    }\n\n    if (this.event == 'pause') {\n      this.playing = false;\n      this.paused = true;\n      if (this._pos >= this._duration) this._pos = this._duration - 1;\n      this._p0 = this._pos;\n      this.sndOff();\n      this.event = undefined;\n    }\n\n    if (this.playing) JZZ.lib.schedule(this._tick);\n  };\n\n  Player.prototype.trim = function () {\n    var i, j, e;\n    var data = [];\n    j = 0;\n\n    for (i = 0; i < this._data.length; i++) {\n      e = this._data[i];\n\n      if (e.length || e.ff == 1 || e.ff == 5) {\n        for (; j <= i; j++) data.push(this._data[j]);\n      }\n    }\n\n    var dt = (i ? this._data[i - 1].tt : 0) - (j ? this._data[j - 1].tt : 0);\n    this._data = data;\n\n    this._timing();\n\n    return dt;\n  };\n\n  Player.prototype._timing = function () {\n    var i, m, t, e;\n    this._duration = this._data.length ? this._data[this._data.length - 1].tt : 0;\n    this._ttt = [];\n\n    if (this.ppqn) {\n      this._mul = this.ppqn / 500.0; // 120 bpm\n\n      m = this._mul;\n      t = 0;\n      this._durationMS = 0;\n\n      this._ttt.push({\n        t: 0,\n        m: m,\n        ms: 0\n      });\n\n      for (i = 0; i < this._data.length; i++) {\n        e = this._data[i];\n\n        if (e.ff == 0x51) {\n          this._durationMS += (e.tt - t) / m;\n          t = e.tt;\n          m = this.ppqn * 1000.0 / _div(e.dd);\n\n          this._ttt.push({\n            t: t,\n            m: m,\n            ms: this._durationMS\n          });\n        }\n      }\n\n      this._durationMS += (this._duration - t) / m;\n    } else {\n      this._mul = this.fps * this.ppf / 1000.0; // 1s = fps*ppf ticks\n\n      this._ttt.push({\n        t: 0,\n        m: this._mul,\n        ms: 0\n      });\n\n      this._durationMS = this._duration / this._mul;\n    }\n\n    this._speed = 1;\n    this.mul = this._mul;\n\n    this._ttt.push({\n      t: this._duration,\n      m: 0,\n      ms: this._durationMS\n    });\n\n    if (!this._durationMS) this._durationMS = 1;\n  };\n\n  Player.prototype.speed = function (x) {\n    if (typeof x != 'undefined') {\n      if (isNaN(parseFloat(x)) || x <= 0) x = 1;\n      this._speed = x;\n      this.mul = this._mul * this._speed;\n      this._p0 = this._pos - (_now() - this._t0) * this.mul;\n    }\n\n    return this._speed;\n  };\n\n  Player.prototype.type = function () {\n    return this._type;\n  };\n\n  Player.prototype.tracks = function () {\n    return this._tracks;\n  };\n\n  Player.prototype.duration = function () {\n    return this._duration;\n  };\n\n  Player.prototype.durationMS = function () {\n    return this._durationMS;\n  };\n\n  Player.prototype.position = function () {\n    return this._pos;\n  };\n\n  Player.prototype.positionMS = function () {\n    return this.tick2ms(this._pos);\n  };\n\n  Player.prototype.jump = function (t) {\n    if (isNaN(parseFloat(t))) _error('Not a number: ' + t);\n    if (t < 0) t = 0.0;\n    if (t >= this._duration) t = this._duration - 1;\n\n    this._goto(t);\n  };\n\n  Player.prototype.jumpMS = function (ms) {\n    if (isNaN(parseFloat(ms))) _error('Not a number: ' + ms);\n    if (ms < 0) ms = 0.0;\n    if (ms >= this._durationMS) ms = this._durationMS - 1;\n\n    this._goto(this._ms2t(ms));\n  };\n\n  Player.prototype._t2ms = function (t) {\n    if (!t) return 0.0;\n    var i;\n\n    for (i = 0; this._ttt[i].t < t; i++);\n\n    i--;\n    return this._ttt[i].ms + (t - this._ttt[i].t) / this._ttt[i].m;\n  };\n\n  Player.prototype._ms2t = function (ms) {\n    if (!ms) return 0.0;\n    var i;\n\n    for (i = 0; this._ttt[i].ms < ms; i++);\n\n    i--;\n    return this._ttt[i].t + (ms - this._ttt[i].ms) * this._ttt[i].m;\n  };\n\n  Player.prototype._goto = function (t) {\n    this._pos = t;\n    if (!this.playing) this.paused = !!t;\n\n    this._toPos();\n\n    if (this.playing) this.sndOff();\n  };\n\n  Player.prototype._toPos = function () {\n    for (this._ptr = 0; this._ptr < this._data.length; this._ptr++) {\n      var e = this._data[this._ptr];\n      if (e.tt >= this._pos) break;\n      if (e.ff == 0x51 && this.ppqn) this._mul = this.ppqn * 1000.0 / _div(e.dd);\n    }\n\n    this.mul = this._mul * this._speed;\n    this._t0 = _now();\n    this._p0 = this._pos;\n  };\n\n  Player.prototype.tick2ms = function (t) {\n    if (isNaN(parseFloat(t))) _error('Not a number: ' + t);\n    if (t <= 0) return 0.0;\n    if (t >= this._duration) return this._durationMS;\n    return this._t2ms(t);\n  };\n\n  Player.prototype.ms2tick = function (t) {\n    if (isNaN(parseFloat(t))) _error('Not a number: ' + t);\n    if (t <= 0) return 0.0;\n    if (t >= this._durationMS) return this._duration;\n    return this._ms2t(t);\n  };\n\n  JZZ.MIDI.SMF = SMF;\n\n  function _not_a_syx() {\n    _error('Not a SYX file');\n  }\n\n  function SYX(arg) {\n    var self = this instanceof SYX ? this : self = new SYX();\n    self._orig = self;\n\n    if (typeof arg != 'undefined') {\n      if (arg instanceof SMF) {\n        self.copy(arg.player()._data);\n        return self;\n      }\n\n      if (arg instanceof SYX) {\n        self.copy(arg);\n        return self;\n      }\n\n      try {\n        if (arg instanceof ArrayBuffer) {\n          arg = String.fromCharCode.apply(null, new Uint8Array(arg));\n        }\n      } catch (err) {\n        /**/\n      }\n\n      try {\n        if (arg instanceof Uint8Array || arg instanceof Int8Array) {\n          arg = String.fromCharCode.apply(null, new Uint8Array(arg));\n        }\n      } catch (err) {\n        /**/\n      }\n\n      try {\n        /* istanbul ignore next */\n        if (arg instanceof Buffer) {\n          arg = arg.toString('binary');\n        }\n      } catch (err) {\n        /**/\n      }\n\n      if (typeof arg != 'string') {\n        arg = String.fromCharCode.apply(null, arg);\n      }\n\n      var x;\n      var msg = [];\n      var i = 0;\n      var off = 0;\n\n      while (i < arg.length) {\n        if (arg.charCodeAt(i) != 0xf0) _not_a_syx();\n\n        while (i < arg.length) {\n          x = arg.charCodeAt(i);\n          msg.push(x);\n\n          if (x == 0xf7) {\n            msg = JZZ.MIDI(msg);\n            msg._off = off;\n            self.push(JZZ.MIDI(msg));\n            msg = [];\n            off = i + 1;\n            break;\n          }\n\n          i++;\n        }\n\n        i++;\n      }\n\n      if (msg.length) _not_a_syx();\n      return self;\n    }\n\n    return self;\n  }\n\n  SYX.version = function () {\n    return _ver;\n  };\n\n  SYX.prototype = [];\n  SYX.prototype.constructor = SYX;\n\n  SYX.prototype.copy = function (data) {\n    for (var i = 0; i < data.length; i++) if (!data[i].isSMF()) {\n      if (data[i].isFullSysEx()) this.push(JZZ.MIDI(data[i]));else _not_a_syx();\n    }\n  };\n\n  SYX.prototype.validate = function () {\n    return [];\n  };\n\n  SYX.prototype.dump = function () {\n    var i,\n        j,\n        s = '';\n\n    for (i = 0; i < this.length; i++) for (j = 0; j < this[i].length; j++) s += String.fromCharCode(this[i][j]);\n\n    return s;\n  };\n\n  SYX.prototype.toBuffer = function () {\n    return Buffer.from(this.dump(), 'binary');\n  };\n\n  SYX.prototype.toUint8Array = function () {\n    var str = this.dump();\n    var buf = new ArrayBuffer(str.length);\n    var arr = new Uint8Array(buf);\n\n    for (var i = 0; i < str.length; i++) arr[i] = str.charCodeAt(i);\n\n    return arr;\n  };\n\n  SYX.prototype.toArrayBuffer = function () {\n    return this.toUint8Array().buffer;\n  };\n\n  SYX.prototype.toInt8Array = function () {\n    return new Int8Array(this.toArrayBuffer());\n  };\n\n  SYX.prototype.toString = function () {\n    var i;\n    var a = ['SYX:'];\n\n    for (i = 0; i < this.length; i++) {\n      a.push(this[i].toString());\n    }\n\n    return a.join('\\n  ');\n  };\n\n  SYX.prototype.annotate = function () {\n    var ctxt = JZZ.Context();\n\n    for (var i = 0; i < this.length; i++) {\n      if (this[i].lbl) this[i].lbl = undefined;\n\n      ctxt._read(this[i]);\n    }\n\n    return this;\n  };\n\n  SYX.prototype.player = function () {\n    var pl = new Player();\n    pl.ppqn = 96;\n    var i;\n\n    for (i = 0; i < this.length; i++) {\n      var e = JZZ.MIDI(this[i]);\n      e.tt = 0;\n\n      pl._data.push(e);\n    }\n\n    pl._type = 0;\n    pl._tracks = 1;\n\n    pl._timing();\n\n    pl.sndOff = function () {};\n\n    return pl;\n  };\n\n  SYX.prototype._ch = undefined;\n  SYX.prototype._sxid = 0x7f;\n\n  SYX.prototype._image = function () {\n    var F = function () {};\n\n    F.prototype = this._orig;\n    var img = new F();\n    img._ch = this._ch;\n    img._sxid = this._sxid;\n    return img;\n  };\n\n  SYX.prototype.add = function (msg) {\n    msg = JZZ.MIDI(msg);\n    if (msg.isFullSysEx()) this._orig.push(msg);\n    return this;\n  };\n\n  SYX.prototype.send = function (msg) {\n    return this.add(msg);\n  };\n\n  SYX.prototype.sxId = function (id) {\n    if (typeof id == 'undefined') id = SYX.prototype._sxid;\n    if (id == this._sxid) return this;\n    if (id != parseInt(id) || id < 0 || id > 0x7f) throw RangeError('Bad MIDI value: ' + id);\n\n    var img = this._image();\n\n    img._sxid = id;\n    return img;\n  };\n\n  SYX.prototype.ch = function (c) {\n    if (c == this._ch || typeof c == 'undefined' && typeof this._ch == 'undefined') return this;\n\n    if (typeof c != 'undefined') {\n      if (c != parseInt(c) || c < 0 || c > 15) throw RangeError('Bad channel value: ' + c + ' (must be from 0 to 15)');\n    }\n\n    var img = this._image();\n\n    img._ch = c;\n    return img;\n  };\n\n  JZZ.lib.copyMidiHelpers(SYX);\n  JZZ.MIDI.SYX = SYX;\n});","map":{"version":3,"sources":["C:/Users/31505/Desktop/MemomusicFront1111-main/node_modules/jzz-midi-smf/javascript/JZZ.midi.SMF.js"],"names":["global","factory","exports","module","define","amd","JZZ","MIDI","SMF","_ver","_now","lib","now","_error","s","Error","_num","n","String","fromCharCode","_num2","_num4","_num4le","self","ppqn","type","fps","ppf","arguments","length","copy","SYX","push","MTrk","i","add","ArrayBuffer","load","apply","Uint8Array","err","Int8Array","Buffer","toString","parseInt","isNaN","version","prototype","constructor","smf","rmi","ntrk","_issue","off","msg","data","tick","track","w","_complain","_warn","substr","charCodeAt","loadSMF","MThd0006","z","indexOf","_off","_off_type","_off_ntrk","_off_fps","_off_ppf","_off_ppqn","p","offset","len","Chunk","Warn","obj","k","hasOwnProperty","a","join","tracks","t","_reset_state","rm","rl","_check_unused","_update_state","isGmReset","isGsReset","isXgReset","st","ch","m","bm","bl","nl","nm","tt","c","x","str","validate","mm","_sort","_validate","_validate_midi","sort","b","dump","toBuffer","from","toUint8Array","buf","arr","toArrayBuffer","buffer","toInt8Array","_var2num","_msglen","j","pp","annotate","ctxt","Context","lbl","undefined","_read","player","pl","Player","e","tr","_data","_type","_tracks","_timing","d","sub","_validate_msg_data","trk","_validate_number","nn","_orig","_tick","Event","_shortmsg","lastIndexOf","_metaevent_len","name","dd","_timing_first_track","t1","issue","ff","splice","_ch","_sxid","_image","F","img","send","RangeError","sxId","id","note","v","noteOn","noteOff","copyMidiHelpers","midi","Widget","_info","manufacturer","playing","_loop","_pos","onEnd","loop","play","event","paused","_ptr","_p0","_t0","stop","pause","resume","sndOff","_emit","allSoundOff","resetAllControllers","_filter","_receive","filter","f","Function","_div","_mul","mul","_speed","_duration","schedule","trim","dt","_ttt","_durationMS","ms","speed","parseFloat","duration","durationMS","position","positionMS","tick2ms","jump","_goto","jumpMS","_ms2t","_t2ms","_toPos","ms2tick","_not_a_syx","arg","isSMF","isFullSysEx"],"mappings":"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","sourcesContent":["(function(global, factory) {\r\n  /* istanbul ignore next */\r\n  if (typeof exports === 'object' && typeof module !== 'undefined') {\r\n    module.exports = factory;\r\n  }\r\n  else if (typeof define === 'function' && define.amd) {\r\n    define('JZZ.midi.SMF', ['JZZ'], factory);\r\n  }\r\n  else {\r\n    factory(JZZ);\r\n  }\r\n})(this, function(JZZ) {\r\n\r\n  /* istanbul ignore next */\r\n  if (JZZ.MIDI.SMF) return;\r\n\r\n  var _ver = '1.6.7';\r\n\r\n  var _now = JZZ.lib.now;\r\n  function _error(s) { throw new Error(s); }\r\n\r\n  function _num(n) {\r\n    var s = '';\r\n    if (n > 0x1fffff) s += String.fromCharCode(((n >> 21) & 0x7f) + 0x80);\r\n    if (n > 0x3fff) s += String.fromCharCode(((n >> 14) & 0x7f) + 0x80);\r\n    if (n > 0x7f) s += String.fromCharCode(((n >> 7) & 0x7f) + 0x80);\r\n    s += String.fromCharCode(n & 0x7f);\r\n    return s;\r\n  }\r\n  function _num2(n) {\r\n    return String.fromCharCode(n >> 8) + String.fromCharCode(n & 0xff);\r\n  }\r\n  function _num4(n) {\r\n    return String.fromCharCode((n >> 24) & 0xff) + String.fromCharCode((n >> 16) & 0xff) + String.fromCharCode((n >> 8) & 0xff) + String.fromCharCode(n & 0xff);\r\n  }\r\n  function _num4le(n) {\r\n    return String.fromCharCode(n & 0xff) + String.fromCharCode((n >> 8) & 0xff) + String.fromCharCode((n >> 16) & 0xff) + String.fromCharCode((n >> 24) & 0xff);\r\n  }\r\n\r\n  function SMF() {\r\n    var self = this;\r\n    if (!(self instanceof SMF)) {\r\n      self = new SMF();\r\n      delete self.ppqn;\r\n    }\r\n    var type = 1;\r\n    var ppqn = 96;\r\n    var fps;\r\n    var ppf;\r\n    if (arguments.length == 1) {\r\n      if (arguments[0] instanceof SMF) {\r\n        return arguments[0].copy();\r\n      }\r\n      if (arguments[0] instanceof SYX) {\r\n        self.type = 0;\r\n        self.ppqn = ppqn;\r\n        self.push(new MTrk());\r\n        for (var i = 0; i < arguments[0].length; i++) self[0].add(0, arguments[0][i]);\r\n        return self;\r\n      }\r\n      try {\r\n        if (arguments[0] instanceof ArrayBuffer) {\r\n          self.load(String.fromCharCode.apply(null, new Uint8Array(arguments[0])));\r\n          return self;\r\n        }\r\n      }\r\n      catch (err) {/**/}\r\n      try {\r\n        if (arguments[0] instanceof Uint8Array || arguments[0] instanceof Int8Array) {\r\n          self.load(String.fromCharCode.apply(null, new Uint8Array(arguments[0])));\r\n          return self;\r\n        }\r\n      }\r\n      catch (err) {/**/}\r\n      try {\r\n        /* istanbul ignore next */\r\n        if (arguments[0] instanceof Buffer) {\r\n          self.load(arguments[0].toString('binary'));\r\n          return self;\r\n        }\r\n      }\r\n      catch (err) {/**/}\r\n      if (typeof arguments[0] == 'string' && arguments[0] != '0' && arguments[0] != '1' && arguments[0] != '2') {\r\n        self.load(arguments[0]);\r\n        return self;\r\n      }\r\n      type = parseInt(arguments[0]);\r\n    }\r\n    else if (arguments.length == 2) {\r\n      type = parseInt(arguments[0]);\r\n      ppqn = parseInt(arguments[1]);\r\n    }\r\n    else if (arguments.length == 3) {\r\n      type = parseInt(arguments[0]);\r\n      fps = parseInt(arguments[1]);\r\n      ppf = parseInt(arguments[2]);\r\n    }\r\n    else if (arguments.length) _error('Invalid parameters');\r\n    if (isNaN(type) || type < 0 || type > 2) _error('Invalid parameters');\r\n    self.type = type;\r\n    if (typeof fps == 'undefined') {\r\n      if (isNaN(ppqn) || ppqn < 0 || ppqn > 0xffff) _error('Invalid parameters');\r\n      self.ppqn = ppqn;\r\n    }\r\n    else {\r\n      if (fps != 24 && fps != 25 && fps != 29 && fps != 30) _error('Invalid parameters');\r\n      if (isNaN(ppf) || ppf < 0 || ppf > 0xff) _error('Invalid parameters');\r\n      self.fps = fps;\r\n      self.ppf = ppf;\r\n    }\r\n    return self;\r\n  }\r\n  SMF.version = function() { return _ver; };\r\n\r\n  SMF.prototype = [];\r\n  SMF.prototype.constructor = SMF;\r\n  SMF.prototype.copy = function() {\r\n    var smf = new SMF();\r\n    smf.type = this.type;\r\n    smf.ppqn = this.ppqn;\r\n    smf.fps = this.fps;\r\n    smf.ppf = this.ppf;\r\n    smf.rmi = this.rmi;\r\n    smf.ntrk = this.ntrk;\r\n    for (var i = 0; i < this.length; i++) smf.push(this[i].copy());\r\n    return smf;\r\n  };\r\n\r\n  function _issue(off, msg, data, tick, track) {\r\n    var w = { off: off, msg: msg, data: data };\r\n    if (typeof tick != 'undefined') w.tick = tick;\r\n    if (typeof track != 'undefined') w.track = track;\r\n    return w;\r\n  }\r\n  SMF.prototype._complain = function(off, msg, data) {\r\n    if (!this._warn) this._warn = [];\r\n    this._warn.push(_issue(off, msg, data));\r\n  };\r\n  SMF.prototype.load = function(s) {\r\n    var off = 0;\r\n    if (s.substr(0, 4) == 'RIFF' && s.substr(8, 8) == 'RMIDdata') {\r\n      this.rmi = true;\r\n      off = 20;\r\n      s = s.substr(20, s.charCodeAt(16) + s.charCodeAt(17) * 0x100 + s.charCodeAt(18) * 0x10000 + s.charCodeAt(19) * 0x1000000);\r\n    }\r\n    this.loadSMF(s, off);\r\n  };\r\n\r\n  var MThd0006 = 'MThd' + String.fromCharCode(0) + String.fromCharCode(0) + String.fromCharCode(0) + String.fromCharCode(6);\r\n  SMF.prototype.loadSMF = function(s, off) {\r\n    if (!s.length) _error('Empty file');\r\n    if (s.substr(0, 8) != MThd0006) {\r\n      var z = s.indexOf(MThd0006);\r\n      if (z != -1) {\r\n        s = s.substr(z);\r\n        this._complain(off, 'Extra leading characters', z);\r\n        off += z;\r\n      }\r\n      else _error('Not a MIDI file');\r\n    }\r\n    this._off = off;\r\n    this.type = s.charCodeAt(8) * 16 + s.charCodeAt(9);\r\n    this._off_type = off + 8;\r\n    this.ntrk = s.charCodeAt(10) * 16 + s.charCodeAt(11);\r\n    this._off_ntrk = off + 10;\r\n    if (s.charCodeAt(12) > 0x7f) {\r\n      this.fps = 0x100 - s.charCodeAt(12);\r\n      this.ppf = s.charCodeAt(13);\r\n      this._off_fps = off + 12;\r\n      this._off_ppf = off + 13;\r\n    }\r\n    else{\r\n      this.ppqn = s.charCodeAt(12) * 256 + s.charCodeAt(13);\r\n      this._off_ppqn = off + 12;\r\n    }\r\n    if (this.type > 2) this._complain(8 + off, 'Invalid MIDI file type', this.type);\r\n    else if (this.type == 0 && this.ntrk > 1) this._complain(10 + off, 'Wrong number of tracks for the type 0 MIDI file', this.ntrk);\r\n    if (!this.ppf && !this.ppqn) _error('Invalid MIDI header');\r\n    var n = 0;\r\n    var p = 14;\r\n    while (p < s.length - 8) {\r\n      var offset = p + off;\r\n      var type = s.substr(p, 4);\r\n      if (type == 'MTrk') n++;\r\n      var len = (s.charCodeAt(p + 4) << 24) + (s.charCodeAt(p + 5) << 16) + (s.charCodeAt(p + 6) << 8) + s.charCodeAt(p + 7);\r\n      if (len <= 0) { // broken file\r\n        len = s.length - p - 8;\r\n        this._complain(p + off + 4, 'Invalid track length', s.charCodeAt(p + 4) + '/' + s.charCodeAt(p + 5) + '/' + s.charCodeAt(p + 6) + '/' + s.charCodeAt(p + 7));\r\n      }\r\n      p += 8;\r\n      var data = s.substr(p, len);\r\n      this.push(new Chunk(type, data, offset));\r\n      if (type == 'MThd') this._complain(offset, 'Unexpected chunk type', 'MThd');\r\n      p += len;\r\n    }\r\n    if (n != this.ntrk) {\r\n      this._complain(off + 10, 'Incorrect number of tracks', this.ntrk);\r\n      this.ntrk = n;\r\n    }\r\n    if (!this.ntrk)  _error('No MIDI tracks');\r\n    if (!this.type && this.ntrk > 1 || this.type > 2)  this.type = 1;\r\n    if (p < s.length) this._complain(off + p, 'Extra trailing characters', s.length - p);\r\n    if (p > s.length) this._complain(off + s.length, 'Incomplete data', p - s.length);\r\n  };\r\n\r\n  function Warn(obj) {\r\n    if (!(this instanceof Warn)) return new Warn(obj);\r\n    for (var k in obj) if (obj.hasOwnProperty(k)) this[k] = obj[k];\r\n  }\r\n  Warn.prototype.toString = function() {\r\n    var a = [];\r\n    if (typeof this.off != 'undefined') a.push('offset ' + this.off);\r\n    if (typeof this.track != 'undefined') a.push('track ' + this.track);\r\n    if (typeof this.tick != 'undefined') a.push('tick ' + this.tick);\r\n    return a.join(' ') + ' -- ' + this.msg + ' (' + this.data + ')';\r\n  };\r\n\r\n  SMF.prototype.tracks = function() {\r\n    var t = 0;\r\n    for (var i = 0; i < this.length; i++) if (this[i] instanceof MTrk) t++;\r\n    return t;\r\n  };\r\n\r\n  function _reset_state(w, s) {\r\n    var i;\r\n    for (i = 0; i < 16; i++) {\r\n      if (s[i]) {\r\n        if (s[i].rm && s[i].rl && s[i].rm[0][2] == 0x7f && s[i].rl[0][2] == 0x7f) {\r\n          s[i].rm[1] = true;\r\n          s[i].rl[1] = true;\r\n        }\r\n        _check_unused(w, s, i, 'bm');\r\n        _check_unused(w, s, i, 'bl');\r\n        _check_unused(w, s, i, 'nm');\r\n        _check_unused(w, s, i, 'nl');\r\n        _check_unused(w, s, i, 'rm');\r\n        _check_unused(w, s, i, 'rl');\r\n      }\r\n      s[i] = {};\r\n    }\r\n  }\r\n  function _update_state(w, s, msg) {\r\n    if (!msg.length || msg[0] < 0x80) return;\r\n    if (msg.isGmReset() || msg.isGsReset() || msg.isXgReset()) {\r\n      _reset_state(w, s);\r\n      return;\r\n    }\r\n    var st = msg[0] >> 4;\r\n    var ch = msg[0] & 15;\r\n    var m;\r\n    if (st == 0xb) {\r\n      switch (msg[1]) {\r\n        case 0:\r\n          _check_unused(w, s, ch, 'bm');\r\n          s[ch].bm = [msg, false];\r\n          break;\r\n        case 0x20:\r\n          _check_unused(w, s, ch, 'bl');\r\n          s[ch].bl = [msg, false];\r\n          break;\r\n        case 0x62:\r\n          _check_unused(w, s, ch, 'nl');\r\n          _check_unused(w, s, ch, 'rm');\r\n          _check_unused(w, s, ch, 'rl');\r\n          s[ch].nl = [msg, false];\r\n          break;\r\n        case 0x63:\r\n          _check_unused(w, s, ch, 'nm');\r\n          _check_unused(w, s, ch, 'rm');\r\n          _check_unused(w, s, ch, 'rl');\r\n          s[ch].nm = [msg, false];\r\n          break;\r\n        case 0x64:\r\n          _check_unused(w, s, ch, 'rl');\r\n          _check_unused(w, s, ch, 'nm');\r\n          _check_unused(w, s, ch, 'nl');\r\n          s[ch].rl = [msg, false];\r\n          break;\r\n        case 0x65:\r\n          _check_unused(w, s, ch, 'rm');\r\n          _check_unused(w, s, ch, 'nm');\r\n          _check_unused(w, s, ch, 'nl');\r\n          s[ch].rm = [msg, false];\r\n          break;\r\n        case 0x6: case 0x26: case 0x60: case 0x61:\r\n          if (s[ch].rm && s[ch].rl) {\r\n            s[ch].rm[1] = true;\r\n            s[ch].rl[1] = true;\r\n          }\r\n          if (s[ch].rm && !s[ch].rl && !s[ch].rm[1]) {\r\n            m = s[ch].rm[0];\r\n            w.push(_issue(m._off, 'No matching RPN LSB', m.toString(), m.tt, m.track));\r\n            s[ch].rm[1] = true;\r\n          }\r\n          if (!s[ch].rm && s[ch].rl && !s[ch].rl[1]) {\r\n            m = s[ch].rl[0];\r\n            w.push(_issue(m._off, 'No matching RPN MSB', m.toString(), m.tt, m.track));\r\n            s[ch].rl[1] = true;\r\n          }\r\n          if (s[ch].nm && s[ch].nl) {\r\n            s[ch].nm[1] = true;\r\n            s[ch].nl[1] = true;\r\n          }\r\n          if (s[ch].nm && !s[ch].nl && !s[ch].nm[1]) {\r\n            m = s[ch].nm[0];\r\n            w.push(_issue(m._off, 'No matching NRPN LSB', m.toString(), m.tt, m.track));\r\n            s[ch].nm[1] = true;\r\n          }\r\n          if (!s[ch].nm && s[ch].nl && !s[ch].nl[1]) {\r\n            m = s[ch].nl[0];\r\n            w.push(_issue(m._off, 'No matching NRPN MSB', m.toString(), m.tt, m.track));\r\n            s[ch].nl[1] = true;\r\n          }\r\n          if (!s[ch].rm && !s[ch].rl && !s[ch].nm && !s[ch].nl) {\r\n            w.push(_issue(msg._off, 'RPN/NRPN not set', msg.toString(), msg.tt, msg.track));\r\n          }\r\n          if (s[ch].rm && s[ch].rl && s[ch].rm[0][2] == 0x7f && s[ch].rl[0][2] == 0x7f) {\r\n            w.push(_issue(msg._off, 'RPN/NRPN not set', msg.toString(), msg.tt, msg.track));\r\n          }\r\n          break;\r\n      }\r\n      return;\r\n    }\r\n    if (st == 0xc) {\r\n      if (s[ch].bm) s[ch].bm[1] = true;\r\n      if (s[ch].bl) s[ch].bl[1] = true;\r\n      if (s[ch].bl && !s[ch].bm) {\r\n        m = s[ch].bl[0];\r\n        w.push(_issue(m._off, 'No matching Bank Select MSB', m.toString(), m.tt, m.track));\r\n      }\r\n      if (s[ch].bm && !s[ch].bl) {\r\n        m = s[ch].bm[0];\r\n        w.push(_issue(m._off, 'No matching Bank Select LSB', m.toString(), m.tt, m.track));\r\n      }\r\n    }\r\n  }\r\n  function _check_unused(w, s, c, x) {\r\n    if (s[c][x] && !s[c][x][1]) {\r\n      var str;\r\n      switch (x) {\r\n        case 'bm': case 'bl': str = 'Unnecessary Bank Select'; break;\r\n        case 'nm': case 'nl': str = 'Unnecessary NRPN'; break;\r\n        case 'rm': case 'rl': str = 'Unnecessary RPN'; break;\r\n      }\r\n      var m = s[c][x][0];\r\n      w.push(_issue(m._off, str, m.toString(), m.tt, m.track));\r\n      delete s[c][x];\r\n    }\r\n  }\r\n  SMF.prototype.validate = function() {\r\n    var i, k, z;\r\n    var w = [];\r\n    if (this._warn) for (i = 0; i < this._warn.length; i++) w.push(Warn(this._warn[i]));\r\n    var mm = _sort(this);\r\n    k = 0;\r\n    for (i = 0; i < this.length; i++) if (this[i] instanceof MTrk) {\r\n      this[i]._validate(w, k);\r\n      k++;\r\n    }\r\n    var st = {};\r\n    _reset_state(w, st);\r\n    for (i = 0; i < mm.length; i++) {\r\n      z = _validate_midi(mm[i], this.type == 1);\r\n      if (z) {\r\n        z.track = mm[i].track;\r\n        w.push(z);\r\n      }\r\n      _update_state(w, st, mm[i]);\r\n    }\r\n    _reset_state(w, st);\r\n    w.sort(function(a, b) {\r\n      return (a.off || 0) - (b.off || 0) || (a.track || 0) - (b.track || 0) || (a.tick || 0) - (b.tick || 0);\r\n    });\r\n    if (w.length) {\r\n      for (i = 0; i < w.length; i++) w[i] = Warn(w[i]);\r\n      return w;\r\n    }\r\n  };\r\n  SMF.prototype.dump = function(rmi) {\r\n    var s = '';\r\n    if (rmi) {\r\n      s = this.dump();\r\n      return 'RIFF' + _num4le(s.length + 12) + 'RMIDdata' + _num4le(s.length) + s;\r\n    }\r\n    this.ntrk = 0;\r\n    for (var i = 0; i < this.length; i++) {\r\n      if (this[i] instanceof MTrk) this.ntrk++;\r\n      s += this[i].dump();\r\n    }\r\n    s = (this.ppqn ? _num2(this.ppqn) : String.fromCharCode(0x100 - this.fps) + String.fromCharCode(this.ppf)) + s;\r\n    s = MThd0006 + String.fromCharCode(0) + String.fromCharCode(this.type) + _num2(this.ntrk) + s;\r\n    return s;\r\n  };\r\n  SMF.prototype.toBuffer = function(rmi) {\r\n    return Buffer.from(this.dump(rmi), 'binary');\r\n  };\r\n  SMF.prototype.toUint8Array = function(rmi) {\r\n    var str = this.dump(rmi);\r\n    var buf = new ArrayBuffer(str.length);\r\n    var arr = new Uint8Array(buf);\r\n    for (var i = 0; i < str.length; i++) arr[i] = str.charCodeAt(i);\r\n    return arr;\r\n  };\r\n  SMF.prototype.toArrayBuffer = function(rmi) {\r\n    return this.toUint8Array(rmi).buffer;\r\n  };\r\n  SMF.prototype.toInt8Array = function(rmi) {\r\n    return new Int8Array(this.toArrayBuffer(rmi));\r\n  };\r\n  SMF.prototype.toString = function() {\r\n    var i;\r\n    this.ntrk = 0;\r\n    for (i = 0; i < this.length; i++) if (this[i] instanceof MTrk) this.ntrk++;\r\n    var a = ['SMF:', '  type: ' + this.type];\r\n    if (this.ppqn) a.push('  ppqn: ' + this.ppqn);\r\n    else a.push('  fps: ' + this.fps, '  ppf: ' + this.ppf);\r\n    a.push('  tracks: ' + this.ntrk);\r\n    for (i = 0; i < this.length; i++) {\r\n      a.push(this[i].toString());\r\n    }\r\n    return a.join('\\n');\r\n  };\r\n\r\n  function _var2num(s) {\r\n    if (!s.length) return 0; // missing last byte\r\n    if (s.charCodeAt(0) < 0x80) return [1, s.charCodeAt(0)];\r\n    var x = s.charCodeAt(0) & 0x7f;\r\n    x <<= 7;\r\n    if (s.charCodeAt(1) < 0x80) return [2, x + s.charCodeAt(1)];\r\n    x += s.charCodeAt(1) & 0x7f;\r\n    x <<= 7;\r\n    if (s.charCodeAt(2) < 0x80) return [3, x + s.charCodeAt(2)];\r\n    x += s.charCodeAt(2) & 0x7f;\r\n    x <<= 7;\r\n    x += s.charCodeAt(3) & 0x7f;\r\n    return [4, s.charCodeAt(3) < 0x80 ? x : -x];\r\n  }\r\n  function _msglen(n) {\r\n    switch (n & 0xf0) {\r\n      case 0x80: case 0x90: case 0xa0: case 0xb0: case 0xe0: return 2;\r\n      case 0xc0: case 0xD0: return 1;\r\n    }\r\n    switch (n) {\r\n      case 0xf1: case 0xf3: return 1;\r\n      case 0xf2: return 2;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  function _sort(smf) {\r\n    var i, j;\r\n    var tt = [];\r\n    var mm = [];\r\n    for (i = 0; i < smf.length; i++) if (smf[i] instanceof MTrk) tt.push(smf[i]);\r\n    if (smf.type != 1) {\r\n      for (i = 0; i < tt.length; i++) {\r\n        for (j = 0; j < tt[i].length; j++) {\r\n          tt[i][j].track = i;\r\n          mm.push(tt[i][j]);\r\n        }\r\n      }\r\n    }\r\n    else {\r\n      var t = 0;\r\n      var pp = [];\r\n      for (i = 0; i < tt.length; i++) pp[i] = 0;\r\n      while (true) {\r\n        var b = true;\r\n        var m = 0;\r\n        for (i = 0; i < tt.length; i++) {\r\n          while (pp[i] < tt[i].length && tt[i][pp[i]].tt == t) {\r\n            tt[i][pp[i]].track = i;\r\n            mm.push(tt[i][pp[i]]);\r\n            pp[i]++;\r\n          }\r\n          if (pp[i] >= tt[i].length) continue;\r\n          if (b) m = tt[i][pp[i]].tt;\r\n          b = false;\r\n          if (m > tt[i][pp[i]].tt) m = tt[i][pp[i]].tt;\r\n        }\r\n        t = m;\r\n        if (b) break;\r\n      }\r\n    }\r\n    return mm;\r\n  }\r\n\r\n  SMF.prototype.annotate = function() {\r\n    var mm = _sort(this);\r\n    var ctxt = JZZ.Context();\r\n    for (var i = 0; i < mm.length; i++) {\r\n      if (mm[i].lbl) mm[i].lbl = undefined;\r\n      ctxt._read(mm[i]);\r\n    }\r\n    return this;\r\n  };\r\n\r\n  SMF.prototype.player = function() {\r\n    var pl = new Player();\r\n    pl.ppqn = this.ppqn;\r\n    pl.fps = this.fps;\r\n    pl.ppf = this.ppf;\r\n    var i;\r\n    var e;\r\n    var mm = _sort(this);\r\n    if (this.type == 2) {\r\n      var tr = 0;\r\n      var m = 0;\r\n      var t = 0;\r\n      for (i = 0; i < mm.length; i++) {\r\n        e = JZZ.MIDI(mm[i]);\r\n        if (tr != e.track) {\r\n          tr = e.track;\r\n          m = t;\r\n        }\r\n        t = e.tt + m;\r\n        e.tt = t;\r\n        pl._data.push(e);\r\n      }\r\n    }\r\n    else {\r\n      for (i = 0; i < mm.length; i++) {\r\n        e = JZZ.MIDI(mm[i]);\r\n        pl._data.push(e);\r\n      }\r\n    }\r\n    pl._type = this.type;\r\n    pl._tracks = this.tracks();\r\n    pl._timing();\r\n    return pl;\r\n  };\r\n\r\n  function Chunk(t, d, off) {\r\n    if (!(this instanceof Chunk)) return new Chunk(t, d, off);\r\n    var i;\r\n    if (this.sub[t]) return this.sub[t](t, d, off);\r\n    if (typeof t != 'string' || t.length != 4) _error(\"Invalid chunk type: \" + t);\r\n    for (i = 0; i < t.length; i++) if (t.charCodeAt(i) < 0 || t.charCodeAt(i) > 255) _error(\"Invalid chunk type: \" + t);\r\n    if (typeof d != 'string') _error(\"Invalid data type: \" + d);\r\n    for (i = 0; i < d.length; i++) if (d.charCodeAt(i) < 0 || d.charCodeAt(i) > 255) _error(\"Invalid data character: \" + d[i]);\r\n    this.type = t;\r\n    this.data = d;\r\n    this._off = off;\r\n  }\r\n  SMF.Chunk = Chunk;\r\n  Chunk.prototype = [];\r\n  Chunk.prototype.constructor = Chunk;\r\n  Chunk.prototype.copy = function() { return new Chunk(this.type, this.data); };\r\n\r\n  Chunk.prototype.sub = {\r\n    'MTrk': function(t, d, off) { return new MTrk(d, off); }\r\n  };\r\n  Chunk.prototype.dump = function() {\r\n    return this.type + _num4(this.data.length) + this.data;\r\n  };\r\n  Chunk.prototype.toString = function() {\r\n    return this.type + ': ' + this.data.length + ' bytes';\r\n  };\r\n\r\n  function _validate_msg_data(trk, s, p, m, t, off) {\r\n    var x = s.substr(p, m);\r\n    if (x.length < m) {\r\n      trk._complain(off, 'Incomplete track data', m - x.length, t);\r\n      x = (x + '\\x00\\x00').substr(0, m);\r\n    }\r\n    for (var i = 0; i < m; i++) if (x.charCodeAt(i) > 127) {\r\n      trk._complain(off + i, 'Bad MIDI value set to 0', x.charCodeAt(i), t);\r\n      x = x.substr(0, i) + '\\x00' + x.substr(i + 1);\r\n    }\r\n    return x;\r\n  }\r\n  function _validate_number(trk, s, off, t, tt) {\r\n    var nn = _var2num(s);\r\n    if (tt) t += nn[1];\r\n    if (nn[1] < 0) {\r\n      nn[1] = -nn[1];\r\n      trk._complain(off, \"Bad byte sequence\", s.charCodeAt(0) + '/' + s.charCodeAt(1) + '/' + s.charCodeAt(2) + '/' + s.charCodeAt(3), t);\r\n    }\r\n    else if (nn[0] == 4 && nn[1] < 0x200000) {\r\n      trk._complain(off, \"Long VLQ value\", s.charCodeAt(0) + '/' + s.charCodeAt(1) + '/' + s.charCodeAt(2) + '/' + s.charCodeAt(3), t);\r\n    }\r\n    else if (nn[0] == 3 && nn[1] < 0x4000) {\r\n      trk._complain(off, \"Long VLQ value\", s.charCodeAt(0) + '/' + s.charCodeAt(1) + '/' + s.charCodeAt(2), t);\r\n    }\r\n    else if (nn[0] == 2 && nn[1] < 0x80) {\r\n      trk._complain(off, \"Long VLQ value\", s.charCodeAt(0) + '/' + s.charCodeAt(1), t);\r\n    }\r\n    return nn;\r\n  }\r\n\r\n  function MTrk(s, off) {\r\n    if (!(this instanceof MTrk)) return new MTrk(s, off);\r\n    this._off = off;\r\n    this._orig = this;\r\n    this._tick = 0;\r\n    if(typeof s == 'undefined') {\r\n      this.push(new Event(0, '\\xff\\x2f', ''));\r\n      return;\r\n    }\r\n    var t = 0;\r\n    var p = 0;\r\n    var w = '';\r\n    var st;\r\n    var m;\r\n    off += 8;\r\n    var offset = p + off;\r\n    while (p < s.length) {\r\n      m = _validate_number(this, s.substr(p, 4), offset, t, true);\r\n      p += m[0];\r\n      t += m[1];\r\n      offset = p + off;\r\n      if (s.charCodeAt(p) == 0xff) {\r\n        st = s.substr(p, 2);\r\n        if (st.length < 2) {\r\n          this._complain(offset, 'Incomplete track data', 3 - st.length, t);\r\n          st = '\\xff\\x2f';\r\n        }\r\n        p += 2;\r\n        m = _validate_number(this, s.substr(p, 4), offset + 2, t);\r\n        p += m[0];\r\n        this.push (new Event(t, st, s.substr(p, m[1]), offset));\r\n        p += m[1];\r\n      }\r\n      else if (s.charCodeAt(p) == 0xf0 || s.charCodeAt(p) == 0xf7) {\r\n        st = s.substr(p, 1);\r\n        p += 1;\r\n        m = _validate_number(this, s.substr(p, 4), offset + 1, t);\r\n        p += m[0];\r\n        this.push(new Event(t, st, s.substr(p, m[1]), offset));\r\n        p += m[1];\r\n      }\r\n      else if (s.charCodeAt(p) & 0x80) {\r\n        w = s.substr(p, 1);\r\n        p += 1;\r\n        m = _msglen(w.charCodeAt(0));\r\n        if (w.charCodeAt(0) > 0xf0) this._complain(offset, 'Unexpected MIDI message', w.charCodeAt(0).toString(16), t);\r\n        this.push(new Event(t, w, _validate_msg_data(this, s, p, m, t, offset + 1), offset));\r\n        p += m;\r\n      }\r\n      else if (w.charCodeAt(0) & 0x80) { // running status\r\n        m = _msglen(w.charCodeAt(0));\r\n        if (w.charCodeAt(0) > 0xf0) this._complain(offset, 'Unexpected MIDI message', w.charCodeAt(0).toString(16), t);\r\n        this.push(new Event(t, w, _validate_msg_data(this, s, p, m, t, offset), offset));\r\n        p += m;\r\n      }\r\n    }\r\n  }\r\n  SMF.MTrk = MTrk;\r\n\r\n  MTrk.prototype = [];\r\n  MTrk.prototype.constructor = MTrk;\r\n  MTrk.prototype.type = 'MTrk';\r\n  MTrk.prototype.copy = function() {\r\n    var trk = new MTrk();\r\n    trk.length = 0;\r\n    for (var i = 0; i < this.length; i++) trk.push(new JZZ.MIDI(this[i]));\r\n    return trk;\r\n  };\r\n  function _shortmsg(msg) {\r\n    var s = msg.toString();\r\n    if (s.length > 80) {\r\n      s = s.substr(0, 78);\r\n      s = s.substr(0, s.lastIndexOf(' ')) + ' ...';\r\n    }\r\n    return s;\r\n  }\r\n  function _metaevent_len(msg, name, len) {\r\n    if (msg.dd.length < len) return _issue(msg._off, 'Invalid ' + name + ' meta event: ' + (msg.dd.length ? 'data too short' : 'no data'), _shortmsg(msg), msg.tt);\r\n    if (msg.dd.length > len) return _issue(msg._off, 'Invalid ' + name + ' meta event: data too long', _shortmsg(msg), msg.tt);\r\n  }\r\n  function _timing_first_track(msg, name) {\r\n    return _issue(msg._off, name + ' meta events must be in the first track', _shortmsg(msg), msg.tt);\r\n  }\r\n  function _validate_midi(msg, t1) {\r\n    var issue;\r\n    if (typeof msg.ff != 'undefined') {\r\n      if (msg.ff > 0x7f) return _issue(msg._off, 'Invalid meta event', _shortmsg(msg), msg.tt);\r\n      else if (msg.ff == 0) {\r\n        issue = _metaevent_len(msg, 'Sequence Number', 2); if (issue) return issue;\r\n      }\r\n      else if (msg.ff < 10) {\r\n        if (!msg.dd.length) return _issue(msg._off, 'Invalid Text meta event: no data', _shortmsg(msg), msg.tt);\r\n      }\r\n      else if (msg.ff == 32) {\r\n        issue = _metaevent_len(msg, 'Channel Prefix', 1); if (issue) return issue;\r\n        if (msg.dd.charCodeAt(0) > 15) return _issue(msg._off, 'Invalid Channel Prefix meta event: incorrect data', _shortmsg(msg), msg.tt);\r\n      }\r\n      else if (msg.ff == 33) {\r\n        issue = _metaevent_len(msg, 'MIDI Port', 1); if (issue) return issue;\r\n        if (msg.dd.charCodeAt(0) > 127) return _issue(msg._off, 'Invalid MIDI Port meta event: incorrect data', _shortmsg(msg), msg.tt);\r\n      }\r\n      else if (msg.ff == 47) {\r\n        issue = _metaevent_len(msg, 'End of Track', 0); if (issue) return issue;\r\n      }\r\n      else if (msg.ff == 81) {\r\n        issue = _metaevent_len(msg, 'Tempo', 3); if (issue) return issue;\r\n        if (t1 && msg.track) return _timing_first_track(msg, 'Tempo');\r\n      }\r\n      else if (msg.ff == 84) {\r\n        issue = _metaevent_len(msg, 'SMPTE', 5); if (issue) return issue;\r\n        if ((msg.dd.charCodeAt(0) & 0x1f) >= 24 || msg.dd.charCodeAt(1) >= 60 || msg.dd.charCodeAt(2) >= 60 || msg.dd.charCodeAt(3) >= 30 || msg.dd.charCodeAt(4) >= 200 || msg.dd.charCodeAt(4) % 25) return _issue(msg._off, 'Invalid SMPTE meta event: incorrect data', _shortmsg(msg), msg.tt);\r\n        else if ((msg.dd.charCodeAt(0) >> 5) > 3) return _issue(msg._off, 'Invalid SMPTE meta event: incorrect format', msg.dd.charCodeAt(0) >> 5, msg.tt);\r\n        if (t1 && msg.track) return _timing_first_track(msg, 'SMPTE');\r\n      }\r\n      else if (msg.ff == 88) {\r\n        issue = _metaevent_len(msg, 'Time Signature', 4); if (issue) return issue;\r\n        if (msg.dd.charCodeAt(1) > 8) return _issue(msg._off, 'Invalid Time Signature meta event: incorrect data', _shortmsg(msg), msg.tt);\r\n        if (t1 && msg.track) return _timing_first_track(msg, 'Time Signature');\r\n      }\r\n      else if (msg.ff == 89) {\r\n        issue = _metaevent_len(msg, 'Key Signature', 2); if (issue) return issue;\r\n        if (msg.dd.charCodeAt(1) > 1 || msg.dd.charCodeAt(0) > 255 || (msg.dd.charCodeAt(0) > 7 && msg.dd.charCodeAt(0) < 249)) return _issue(msg._off, 'Invalid Key Signature meta event: incorrect data', msg.toString(), msg.tt);\r\n      }\r\n      else if (msg.ff == 127) {\r\n        // Sequencer Specific meta event\r\n      }\r\n      else {\r\n        return _issue(msg._off, 'Unknown meta event', _shortmsg(msg), msg.tt);\r\n      }\r\n    }\r\n    else {\r\n      //\r\n    }\r\n  }\r\n  MTrk.prototype._validate = function(w, k) {\r\n    var i, z;\r\n    if (this._warn) for (i = 0; i < this._warn.length; i++) {\r\n      z = Warn(this._warn[i]);\r\n      z.track = k;\r\n      w.push(z);\r\n    }\r\n  };\r\n  MTrk.prototype._complain = function(off, msg, data, tick) {\r\n    if (!this._warn) this._warn = [];\r\n    this._warn.push(_issue(off, msg, data, tick));\r\n  };\r\n  MTrk.prototype.dump = function() {\r\n    var s = '';\r\n    var t = 0;\r\n    var m = '';\r\n    var i, j;\r\n    for (i = 0; i < this.length; i++) {\r\n      s += _num(this[i].tt - t);\r\n      t = this[i].tt;\r\n      if (typeof this[i].dd != 'undefined') {\r\n        s += '\\xff';\r\n        s += String.fromCharCode(this[i].ff);\r\n        s += _num(this[i].dd.length);\r\n        s += this[i].dd;\r\n      }\r\n      else if (this[i][0] == 0xf0 || this[i][0] == 0xf7) {\r\n        s += String.fromCharCode(this[i][0]);\r\n        s += _num(this[i].length - 1);\r\n        for (j = 1; j < this[i].length; j++) s += String.fromCharCode(this[i][j]);\r\n      }\r\n      else {\r\n        if (this[i][0] != m) {\r\n          m = this[i][0];\r\n          s += String.fromCharCode(this[i][0]);\r\n        }\r\n        for (j = 1; j < this[i].length; j++) s += String.fromCharCode(this[i][j]);\r\n      }\r\n    }\r\n    return 'MTrk' + _num4(s.length) + s;\r\n  };\r\n  MTrk.prototype.toString = function() {\r\n    var a = ['MTrk:'];\r\n    for (var i = 0; i < this.length; i++) {\r\n      a.push(this[i].tt + ': ' + this[i].toString());\r\n    }\r\n    return a.join('\\n  ');\r\n  };\r\n\r\n  MTrk.prototype.add = function(t, msg) {\r\n    t = parseInt(t);\r\n    if(isNaN(t) || t < 0) _error('Invalid parameter');\r\n    msg = JZZ.MIDI(msg);\r\n    msg.tt = t;\r\n    if (this[this._orig.length - 1].tt < t) this[this._orig.length - 1].tt = t; // end of track\r\n    if (msg.ff == 0x2f || msg[0] > 0xf0 && msg[0] != 0xf7) return this;\r\n    var i;\r\n    for (i = 0; i < this._orig.length - 1; i++) {\r\n      if (this._orig[i].tt > t) break;\r\n    }\r\n    this._orig.splice(i, 0, msg);\r\n    return this;\r\n  };\r\n\r\n  MTrk.prototype._ch = undefined;\r\n  MTrk.prototype._sxid = 0x7f;\r\n  MTrk.prototype._image = function() {\r\n    var F = function() {}; F.prototype = this._orig;\r\n    var img = new F();\r\n    img._ch = this._ch;\r\n    img._sxid = this._sxid;\r\n    img._tick = this._tick;\r\n    return img;\r\n  };\r\n  MTrk.prototype.send = function(msg) { this._orig.add(this._tick, msg); return this; };\r\n  MTrk.prototype.tick = function(t) {\r\n    if (t != parseInt(t) || t < 0) throw RangeError('Bad tick value: ' + t);\r\n    if (!t) return this;\r\n    var img = this._image();\r\n    img._tick = this._tick + t;\r\n    return img;\r\n  };\r\n  MTrk.prototype.sxId = function(id) {\r\n    if (typeof id == 'undefined') id = MTrk.prototype._sxid;\r\n    if (id == this._sxid) return this;\r\n    if (id != parseInt(id) || id < 0 || id > 0x7f) throw RangeError('Bad MIDI value: ' + id);\r\n    var img = this._image();\r\n    img._sxid = id;\r\n    return img;\r\n  };\r\n  MTrk.prototype.ch = function(c) {\r\n    if (c == this._ch || typeof c == 'undefined' && typeof this._ch == 'undefined') return this;\r\n    if (typeof c != 'undefined') {\r\n      if (c != parseInt(c) || c < 0 || c > 15) throw RangeError('Bad channel value: ' + c  + ' (must be from 0 to 15)');\r\n    }\r\n    var img = this._image();\r\n    img._ch = c;\r\n    return img;\r\n  };\r\n  MTrk.prototype.note = function(c, n, v, t) {\r\n    this.noteOn(c, n, v);\r\n    if (typeof this._ch == 'undefined') {\r\n      if (t > 0) this.tick(t).noteOff(c, n);\r\n    }\r\n    else {\r\n      if (v > 0) this.tick(v).noteOff(c);\r\n    }\r\n    return this;\r\n  };\r\n  JZZ.lib.copyMidiHelpers(MTrk);\r\n\r\n  function Event(t, s, d, off) {\r\n    var midi;\r\n    if (s.charCodeAt(0) == 0xff) {\r\n      midi = JZZ.MIDI.smf(s.charCodeAt(1), d);\r\n    }\r\n    else {\r\n      var a = [s.charCodeAt(0)];\r\n      for (var i = 0; i < d.length; i++) a.push(d.charCodeAt(i));\r\n      midi = JZZ.MIDI(a);\r\n    }\r\n    if (typeof off != 'undefined') midi._off = off;\r\n    midi.tt = t;\r\n    return midi;\r\n  }\r\n\r\n  function Player() {\r\n    var self = new JZZ.Widget();\r\n    self._info.name = 'MIDI Player';\r\n    self._info.manufacturer = 'Jazz-Soft';\r\n    self._info.version = _ver;\r\n    self.playing = false;\r\n    self._loop = 0;\r\n    self._data = [];\r\n    self._pos = 0;\r\n    self._tick = (function(x) { return function(){ x.tick(); }; })(self);\r\n    for (var k in Player.prototype) if (Player.prototype.hasOwnProperty(k)) self[k] = Player.prototype[k];\r\n    return self;\r\n  }\r\n  Player.prototype.onEnd = function() {};\r\n  Player.prototype.loop = function(n) {\r\n    if (n == parseInt(n) && n > 0) this._loop = n;\r\n    else this._loop = n ? -1 : 0;\r\n  };\r\n  Player.prototype.play = function() {\r\n    this.event = undefined;\r\n    this.playing = true;\r\n    this.paused = false;\r\n    this._ptr = 0;\r\n    this._pos = 0;\r\n    this._p0 = 0;\r\n    this._t0 = _now();\r\n    this.tick();\r\n  };\r\n  Player.prototype.stop = function() {\r\n    this._pos = 0;\r\n    this.playing = false;\r\n    this.event = 'stop';\r\n    this.paused = undefined;\r\n  };\r\n  Player.prototype.pause = function() {\r\n    this.event = 'pause';\r\n  };\r\n  Player.prototype.resume = function() {\r\n    if (this.playing) return;\r\n    if (this.paused) {\r\n      this.event = undefined;\r\n      this._t0 = _now();\r\n      this.playing = true;\r\n      this.paused = false;\r\n      this.tick();\r\n    }\r\n    else this.play();\r\n  };\r\n  Player.prototype.sndOff = function() {\r\n    var c;\r\n    for (c = 0; c < 16; c++) this._emit(JZZ.MIDI.allSoundOff(c));\r\n    for (c = 0; c < 16; c++) this._emit(JZZ.MIDI.resetAllControllers(c));\r\n  };\r\n  function _filter(e) { this._receive(e); }\r\n  Player.prototype._filter = _filter;\r\n  Player.prototype.filter = function(f) {\r\n    this._filter = f instanceof Function ? f : _filter;\r\n  };\r\n  function _div(s) { return (s.charCodeAt(0) << 16) + (s.charCodeAt(1) << 8) + s.charCodeAt(2); }\r\n  Player.prototype._receive = function(e) {\r\n    if (e.ff == 0x51 && this.ppqn) {\r\n      this._mul = this.ppqn * 1000.0 / _div(e.dd);\r\n      this.mul = this._mul * this._speed;\r\n      this._t0 = _now();\r\n      this._p0 = this._pos;\r\n    }\r\n    this._emit(e);\r\n  };\r\n  Player.prototype.tick = function() {\r\n    var t = _now();\r\n    var e;\r\n    this._pos = this._p0 + (t - this._t0) * this.mul;\r\n    for(; this._ptr < this._data.length; this._ptr++) {\r\n      e = this._data[this._ptr];\r\n      if (e.tt > this._pos) break;\r\n      this._filter(e);\r\n    }\r\n    if (this._ptr >= this._data.length) {\r\n      if (this._loop && this._loop != -1) this._loop--;\r\n      if (this._loop) {\r\n        this._ptr = 0;\r\n        this._p0 = 0;\r\n        this._t0 = t;\r\n      }\r\n      else this.stop();\r\n      this.onEnd();\r\n    }\r\n    if (this.event == 'stop') {\r\n      this.playing = false;\r\n      this.paused = false;\r\n      this._pos = 0;\r\n      this._ptr = 0;\r\n      this.sndOff();\r\n      this.event = undefined;\r\n    }\r\n    if (this.event == 'pause') {\r\n      this.playing = false;\r\n      this.paused = true;\r\n      if (this._pos >= this._duration) this._pos = this._duration - 1;\r\n      this._p0 = this._pos;\r\n      this.sndOff();\r\n      this.event = undefined;\r\n    }\r\n    if (this.playing) JZZ.lib.schedule(this._tick);\r\n  };\r\n  Player.prototype.trim = function() {\r\n    var i, j, e;\r\n    var data = [];\r\n    j = 0;\r\n    for (i = 0; i < this._data.length; i++) {\r\n      e = this._data[i];\r\n      if (e.length || e.ff == 1 || e.ff == 5) {\r\n        for (; j <= i; j++) data.push(this._data[j]);\r\n      }\r\n    }\r\n    var dt = (i ? this._data[i - 1].tt : 0) - (j ? this._data[j - 1].tt : 0);\r\n    this._data = data;\r\n    this._timing();\r\n    return dt;\r\n  };\r\n  Player.prototype._timing = function() {\r\n    var i, m, t, e;\r\n    this._duration = this._data.length ? this._data[this._data.length - 1].tt : 0;\r\n    this._ttt = [];\r\n    if (this.ppqn) {\r\n      this._mul = this.ppqn / 500.0; // 120 bpm\r\n      m = this._mul;\r\n      t = 0;\r\n      this._durationMS = 0;\r\n      this._ttt.push({ t: 0, m: m, ms: 0 });\r\n      for (i = 0; i < this._data.length; i++) {\r\n        e = this._data[i];\r\n        if (e.ff == 0x51) {\r\n          this._durationMS += (e.tt - t) / m;\r\n          t = e.tt;\r\n          m = this.ppqn * 1000.0 / _div(e.dd);\r\n          this._ttt.push({ t: t, m: m, ms: this._durationMS });\r\n        }\r\n      }\r\n      this._durationMS += (this._duration - t) / m;\r\n    }\r\n    else {\r\n      this._mul = this.fps * this.ppf / 1000.0; // 1s = fps*ppf ticks\r\n      this._ttt.push({ t: 0, m: this._mul, ms: 0 });\r\n      this._durationMS = this._duration / this._mul;\r\n    }\r\n    this._speed = 1;\r\n    this.mul = this._mul;\r\n    this._ttt.push({ t: this._duration, m: 0, ms: this._durationMS });\r\n    if (!this._durationMS) this._durationMS = 1;\r\n  };\r\n  Player.prototype.speed = function(x) {\r\n    if (typeof x != 'undefined') {\r\n      if (isNaN(parseFloat(x)) || x <= 0) x = 1;\r\n      this._speed = x;\r\n      this.mul = this._mul * this._speed;\r\n      this._p0 = this._pos - (_now() - this._t0) * this.mul;\r\n    }\r\n    return this._speed;\r\n  };\r\n  Player.prototype.type = function() { return this._type; };\r\n  Player.prototype.tracks = function() { return this._tracks; };\r\n  Player.prototype.duration = function() { return this._duration; };\r\n  Player.prototype.durationMS = function() { return this._durationMS; };\r\n  Player.prototype.position = function() { return this._pos; };\r\n  Player.prototype.positionMS = function() { return this.tick2ms(this._pos); };\r\n  Player.prototype.jump = function(t) {\r\n    if (isNaN(parseFloat(t))) _error('Not a number: ' + t);\r\n    if (t < 0) t = 0.0;\r\n    if (t >= this._duration) t = this._duration - 1;\r\n    this._goto(t);\r\n  };\r\n  Player.prototype.jumpMS = function(ms) {\r\n    if (isNaN(parseFloat(ms))) _error('Not a number: ' + ms);\r\n    if (ms < 0) ms = 0.0;\r\n    if (ms >= this._durationMS) ms = this._durationMS - 1;\r\n    this._goto(this._ms2t(ms));\r\n  };\r\n  Player.prototype._t2ms = function(t) {\r\n    if (!t) return 0.0;\r\n    var i;\r\n    for (i = 0; this._ttt[i].t < t; i++) ;\r\n    i--;\r\n    return this._ttt[i].ms + (t - this._ttt[i].t) / this._ttt[i].m;\r\n  };\r\n  Player.prototype._ms2t = function(ms) {\r\n    if (!ms) return 0.0;\r\n    var i;\r\n    for (i = 0; this._ttt[i].ms < ms; i++) ;\r\n    i--;\r\n    return this._ttt[i].t + (ms - this._ttt[i].ms) * this._ttt[i].m;\r\n  };\r\n  Player.prototype._goto = function(t) {\r\n    this._pos = t;\r\n    if (!this.playing) this.paused = !!t;\r\n    this._toPos();\r\n    if (this.playing) this.sndOff();\r\n  };\r\n  Player.prototype._toPos = function() {\r\n    for(this._ptr = 0; this._ptr < this._data.length; this._ptr++) {\r\n      var e = this._data[this._ptr];\r\n      if (e.tt >= this._pos) break;\r\n      if (e.ff == 0x51 && this.ppqn) this._mul = this.ppqn * 1000.0 / _div(e.dd);\r\n    }\r\n    this.mul = this._mul * this._speed;\r\n    this._t0 = _now();\r\n    this._p0 = this._pos;\r\n  };\r\n  Player.prototype.tick2ms = function(t) {\r\n    if (isNaN(parseFloat(t))) _error('Not a number: ' + t);\r\n    if (t <= 0) return 0.0;\r\n    if (t >= this._duration) return this._durationMS;\r\n    return this._t2ms(t);\r\n  };\r\n  Player.prototype.ms2tick = function(t) {\r\n    if (isNaN(parseFloat(t))) _error('Not a number: ' + t);\r\n    if (t <= 0) return 0.0;\r\n    if (t >= this._durationMS) return this._duration;\r\n    return this._ms2t(t);\r\n  };\r\n  JZZ.MIDI.SMF = SMF;\r\n\r\n  function _not_a_syx() { _error('Not a SYX file'); }\r\n\r\n  function SYX(arg) {\r\n    var self = this instanceof SYX ? this : self = new SYX();\r\n    self._orig = self;\r\n    if (typeof arg != 'undefined') {\r\n      if (arg instanceof SMF) {\r\n        self.copy(arg.player()._data);\r\n        return self;\r\n      }\r\n      if (arg instanceof SYX) {\r\n        self.copy(arg);\r\n        return self;\r\n      }\r\n      try {\r\n        if (arg instanceof ArrayBuffer) {\r\n          arg = String.fromCharCode.apply(null, new Uint8Array(arg));\r\n        }\r\n      }\r\n      catch (err) {/**/}\r\n      try {\r\n        if (arg instanceof Uint8Array || arg instanceof Int8Array) {\r\n          arg = String.fromCharCode.apply(null, new Uint8Array(arg));\r\n        }\r\n      }\r\n      catch (err) {/**/}\r\n      try {\r\n        /* istanbul ignore next */\r\n        if (arg instanceof Buffer) {\r\n          arg = arg.toString('binary');\r\n        }\r\n      }\r\n      catch (err) {/**/}\r\n      if (typeof arg != 'string') {\r\n        arg = String.fromCharCode.apply(null, arg);\r\n      }\r\n      var x;\r\n      var msg = [];\r\n      var i = 0;\r\n      var off = 0;\r\n      while (i < arg.length) {\r\n        if (arg.charCodeAt(i) != 0xf0) _not_a_syx();\r\n        while (i < arg.length) {\r\n          x = arg.charCodeAt(i);\r\n          msg.push(x);\r\n          if (x == 0xf7) {\r\n            msg = JZZ.MIDI(msg);\r\n            msg._off = off;\r\n            self.push(JZZ.MIDI(msg));\r\n            msg = [];\r\n            off = i + 1;\r\n            break;\r\n          }\r\n          i++;\r\n        }\r\n        i++;\r\n      }\r\n      if (msg.length) _not_a_syx();\r\n      return self;\r\n    }\r\n    return self;\r\n  }\r\n  SYX.version = function() { return _ver; };\r\n  SYX.prototype = [];\r\n  SYX.prototype.constructor = SYX;\r\n\r\n  SYX.prototype.copy = function(data) {\r\n    for (var i = 0; i < data.length; i++) if (!data[i].isSMF()) {\r\n      if (data[i].isFullSysEx()) this.push(JZZ.MIDI(data[i]));\r\n      else _not_a_syx();\r\n    }\r\n  };\r\n  SYX.prototype.validate = function() { return []; };\r\n  SYX.prototype.dump = function() {\r\n    var i, j, s = '';\r\n    for (i = 0; i < this.length; i++) for (j = 0; j < this[i].length; j++) s += String.fromCharCode(this[i][j]);\r\n    return s;\r\n  };\r\n  SYX.prototype.toBuffer = function() {\r\n    return Buffer.from(this.dump(), 'binary');\r\n  };\r\n  SYX.prototype.toUint8Array = function() {\r\n    var str = this.dump();\r\n    var buf = new ArrayBuffer(str.length);\r\n    var arr = new Uint8Array(buf);\r\n    for (var i = 0; i < str.length; i++) arr[i] = str.charCodeAt(i);\r\n    return arr;\r\n  };\r\n  SYX.prototype.toArrayBuffer = function() {\r\n    return this.toUint8Array().buffer;\r\n  };\r\n  SYX.prototype.toInt8Array = function() {\r\n    return new Int8Array(this.toArrayBuffer());\r\n  };\r\n  SYX.prototype.toString = function() {\r\n    var i;\r\n    var a = ['SYX:'];\r\n    for (i = 0; i < this.length; i++) {\r\n      a.push(this[i].toString());\r\n    }\r\n    return a.join('\\n  ');\r\n  };\r\n  SYX.prototype.annotate = function() {\r\n    var ctxt = JZZ.Context();\r\n    for (var i = 0; i < this.length; i++) {\r\n      if (this[i].lbl) this[i].lbl = undefined;\r\n      ctxt._read(this[i]);\r\n    }\r\n    return this;\r\n  };\r\n  SYX.prototype.player = function() {\r\n    var pl = new Player();\r\n    pl.ppqn = 96;\r\n    var i;\r\n    for (i = 0; i < this.length; i++) {\r\n      var e = JZZ.MIDI(this[i]);\r\n      e.tt = 0;\r\n      pl._data.push(e);\r\n    }\r\n    pl._type = 0;\r\n    pl._tracks = 1;\r\n    pl._timing();\r\n    pl.sndOff = function() {};\r\n    return pl;\r\n  };\r\n\r\n  SYX.prototype._ch = undefined;\r\n  SYX.prototype._sxid = 0x7f;\r\n  SYX.prototype._image = function() {\r\n    var F = function() {}; F.prototype = this._orig;\r\n    var img = new F();\r\n    img._ch = this._ch;\r\n    img._sxid = this._sxid;\r\n    return img;\r\n  };\r\n  SYX.prototype.add = function(msg) {\r\n    msg = JZZ.MIDI(msg);\r\n    if (msg.isFullSysEx()) this._orig.push(msg);\r\n    return this;\r\n  };\r\n  SYX.prototype.send = function(msg) { return this.add(msg); };\r\n  SYX.prototype.sxId = function(id) {\r\n    if (typeof id == 'undefined') id = SYX.prototype._sxid;\r\n    if (id == this._sxid) return this;\r\n    if (id != parseInt(id) || id < 0 || id > 0x7f) throw RangeError('Bad MIDI value: ' + id);\r\n    var img = this._image();\r\n    img._sxid = id;\r\n    return img;\r\n  };\r\n  SYX.prototype.ch = function(c) {\r\n    if (c == this._ch || typeof c == 'undefined' && typeof this._ch == 'undefined') return this;\r\n    if (typeof c != 'undefined') {\r\n      if (c != parseInt(c) || c < 0 || c > 15) throw RangeError('Bad channel value: ' + c  + ' (must be from 0 to 15)');\r\n    }\r\n    var img = this._image();\r\n    img._ch = c;\r\n    return img;\r\n  };\r\n  JZZ.lib.copyMidiHelpers(SYX);\r\n\r\n  JZZ.MIDI.SYX = SYX;\r\n});\r\n"]},"metadata":{},"sourceType":"script"}